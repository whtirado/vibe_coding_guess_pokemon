<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Title updated to reflect multiple generations -->
    <title>Who's That Pokémon? (All Gens)</title>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <style>
      :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --secondary-color: #6c757d;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #343a40;
        --text-color: #212529;
        --border-color: #dee2e6;
        --border-radius: 0.375rem; /* Bootstrap default */
        --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      body {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif,
          "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
          "Noto Color Emoji";
        background-color: var(--light-gray);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* Start content at the top */
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
        color: var(--text-color);
      }

      h1 {
        color: var(--dark-gray);
        margin-bottom: 20px; /* Increased margin */
        text-shadow: 1px 1px 2px #ccc;
      }

      /* --- Modernized Setup Form --- */
      #controls-container {
        background-color: #fff;
        padding: 25px 30px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        text-align: center;
        max-width: 500px; /* Slightly wider for better layout */
        width: 100%;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px; /* Spacing between control sections */
      }

      #controls-container h2 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--dark-gray);
        font-size: 1.5em;
      }

      .control-section {
        border-top: 1px solid var(--border-color);
        padding-top: 20px;
        text-align: left; /* Align labels nicely */
      }
      .control-section:first-of-type {
        border-top: none;
        padding-top: 0;
      }

      .control-label {
        display: block;
        font-weight: 600; /* Slightly bolder */
        margin-bottom: 10px;
        color: var(--text-color);
      }

      /* Timer Controls */
      #timer-controls {
        display: flex;
        align-items: center;
        justify-content: center; /* Center timer elements */
        gap: 10px;
      }
      #timer-controls button {
        padding: 8px 12px;
        font-size: 1.1em;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background-color: var(--medium-gray);
        color: var(--dark-gray);
        border-radius: var(--border-radius);
        transition: background-color 0.2s ease, border-color 0.2s ease;
        font-weight: bold;
        line-height: 1; /* Better button height consistency */
      }
      #timer-controls button:hover:not(:disabled) {
        background-color: #d3d9df;
        border-color: #adb5bd;
      }
      #timer-controls button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      #timer-controls span {
        font-size: 1.2em;
        font-weight: bold;
        min-width: 65px;
        display: inline-block;
        text-align: center;
        background-color: var(--light-gray);
        padding: 5px 10px;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
      }

      /* Generation Selection Styles */
      #generation-controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px; /* Space before checkboxes */
        flex-wrap: wrap; /* Allow wrapping on small screens */
        gap: 10px;
      }
      #generation-buttons {
        display: flex;
        gap: 10px; /* Space between buttons */
      }

      #select-all-gens-button,
      #randomize-gens-button {
        padding: 5px 10px;
        font-size: 0.85em;
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #select-all-gens-button:hover,
      #randomize-gens-button:hover {
        background-color: #5a6268;
      }
      #randomize-gens-button {
        background-color: var(--info-color);
      }
      #randomize-gens-button:hover {
        background-color: #138496;
      }

      #generation-selector {
        display: grid; /* Use grid for alignment */
        grid-template-columns: repeat(
          auto-fit,
          minmax(90px, 1fr)
        ); /* Responsive columns */
        gap: 10px; /* Spacing between checkboxes */
        padding: 10px;
        background-color: var(--light-gray);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        margin-top: 5px; /* Space below buttons */
      }
      #random-gen-status {
        display: none; /* Hidden by default */
        font-style: italic;
        color: var(--primary-color);
        background-color: var(--light-gray);
        padding: 10px;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        margin-top: 5px;
        text-align: center;
      }

      .gen-checkbox-label {
        display: flex; /* Use flex for better alignment */
        align-items: center;
        font-weight: normal;
        cursor: pointer;
        padding: 5px;
        border-radius: var(--border-radius);
        transition: background-color 0.15s ease;
      }
      .gen-checkbox-label:hover {
        background-color: var(--medium-gray);
      }
      .gen-checkbox-label input[type="checkbox"] {
        margin-right: 8px; /* Space between checkbox and its text */
        accent-color: var(--primary-color); /* Modern checkbox color */
        width: 1em;
        height: 1em;
      }

      /* Checkbox Option Controls (Cry, Autocomplete, Dex) */
      .checkbox-option {
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: var(--light-gray);
        padding: 12px 15px;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: background-color 0.15s ease;
      }
      .checkbox-option:hover {
        background-color: var(--medium-gray);
      }
      .checkbox-option input[type="checkbox"] {
        margin: 0; /* Remove default margins */
        accent-color: var(--primary-color);
        width: 1.1em;
        height: 1.1em;
      }
      .checkbox-option label {
        margin: 0; /* Remove default margins */
        font-weight: normal;
        flex-grow: 1; /* Label takes remaining space */
        cursor: pointer; /* Make label clickable */
      }

      /* --- Start Button & Loading --- */
      #start-game {
        margin-top: 15px; /* Reduced margin slightly */
        padding: 12px 25px;
        font-size: 1.2em; /* Slightly larger font */
        background-color: var(--success-color);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        width: 100%; /* Full width button */
        font-weight: 500;
      }
      #start-game:hover:not(:disabled) {
        background-color: #218838;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
      }
      #start-game:disabled {
        background-color: var(--secondary-color);
        opacity: 0.7;
        cursor: not-allowed;
      }
      #loading-names {
        font-style: italic;
        color: var(--secondary-color);
        margin-top: 10px;
        font-size: 0.9em;
        display: none; /* Hidden initially */
        text-align: center;
      }

      /* --- Game Container --- */
      #game-container {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        text-align: center;
        max-width: 450px;
        width: 100%;
        margin-bottom: 15px;
        display: none; /* Initially hidden */
      }

      #restart-game {
        background-color: var(--primary-color);
        margin-left: 10px;
        padding: 10px 20px;
        font-size: 1em;
        color: white;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #restart-game:hover {
        background-color: #0056b3;
      }

      #status-display {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        font-size: 1.1em;
        font-weight: 500; /* Slightly less bold */
        color: var(--secondary-color);
      }
      #timer-area span,
      #score-area span {
        color: var(--primary-color);
        font-weight: bold;
      }
      #score-area span.incorrect {
        color: var(--danger-color);
      }

      #pokemon-display {
        margin-bottom: 20px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background-color: var(--light-gray);
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        overflow: hidden; /* Ensure image stays within bounds */
      }

      #pokemon-image {
        max-width: 100%;
        max-height: 180px; /* Slightly smaller to avoid touching edges */
        height: auto;
        display: block; /* Changed from inline-block to block for consistency */
        margin: 0 auto;
        opacity: 1; /* Start opaque */
        /* Removed initial silhouette/hidden here, will be controlled by JS before src is set */
      }
      /* silhouette class applies the filter */
      #pokemon-image.silhouette {
        filter: brightness(0);
        opacity: 1; /* Ensure silhouette is visible */
      }
      /* hidden class controls visibility */
      #pokemon-image.hidden {
        opacity: 0; /* Use opacity for smooth transition */
        /* visibility: hidden; */ /* Alternative, but opacity allows transitions */
      }

      #loading {
        position: absolute;
        font-size: 1.1em;
        color: var(--secondary-color);
        /* display: none; Initially hidden, shown by JS */
      }

      #guess-area {
        position: relative;
        margin-bottom: 15px; /* Increased margin */
      }

      #pokemon-guess {
        width: 100%; /* Full width */
        padding: 12px 15px;
        font-size: 1.1em;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-sizing: border-box;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      #pokemon-guess:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }
      #pokemon-guess:disabled {
        background-color: var(--medium-gray);
        cursor: not-allowed;
      }

      #autocomplete-list {
        list-style: none;
        padding: 0;
        margin: 5px 0 0 0; /* Add margin top */
        position: absolute;
        left: 0; /* Align with input */
        right: 0; /* Align with input */
        top: 100%;
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        max-height: 150px;
        overflow-y: auto;
        z-index: 10;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
      }
      #autocomplete-list li {
        padding: 10px 15px;
        cursor: pointer;
        text-align: left;
        font-size: 1em;
      }
      #autocomplete-list li:hover,
      #autocomplete-list li.autocomplete-highlight {
        background-color: var(--medium-gray);
        color: var(--dark-gray);
      }

      /* Dex Hint Styling */
      #dex-hint {
        min-height: 1.2em; /* Reserve space */
        margin-top: -10px; /* Pull closer to guess area */
        margin-bottom: 10px;
        font-size: 1em;
        font-weight: 500;
        color: var(--info-color);
        display: none; /* Hidden by default */
      }

      #feedback {
        margin-top: 5px; /* Reduced margin because hint is above */
        font-size: 1.2em;
        font-weight: bold;
        min-height: 1.5em;
        color: var(--secondary-color);
        transition: color 0.3s ease;
      }
      #feedback.correct {
        color: var(--success-color);
      }
      #feedback.incorrect {
        color: var(--danger-color);
      }
      #feedback.info {
        color: var(--primary-color);
      }
      #feedback .dex-number {
        font-weight: normal;
        color: var(--secondary-color); /* Slightly muted color for dex number */
        font-size: 0.9em;
        margin-left: 5px;
      }

      #game-actions {
        margin-top: 20px; /* Increased margin */
        display: flex;
        justify-content: center;
        gap: 10px; /* Add space between buttons */
      }

      #skip-pokemon,
      #next-pokemon,
      #restart-game,
      #return-to-setup {
        padding: 10px 20px;
        font-size: 1em;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-weight: 500;
      }

      #skip-pokemon {
        background-color: var(--warning-color);
        color: var(--dark-gray);
        display: none; /* Hidden until round starts */
      }
      #skip-pokemon:hover:not(:disabled) {
        background-color: #e0a800;
      }
      #skip-pokemon:disabled {
        background-color: var(--secondary-color);
        opacity: 0.7;
        cursor: not-allowed;
      }

      #next-pokemon {
        background-color: var(--info-color);
        color: white;
        display: none; /* Hidden initially */
      }
      #next-pokemon:hover {
        background-color: #138496;
      }

      #endgame-controls {
        margin-top: 20px; /* Increased margin */
        display: none; /* Hidden initially */
        gap: 10px;
        justify-content: center;
      }
      #return-to-setup {
        background-color: var(--secondary-color);
        color: white;
      }
      #return-to-setup:hover {
        background-color: #5a6268;
      }
    </style>
  </head>
  <body>
    <h1>Who's That Pokémon?</h1>

    <div id="controls-container">
      <h2>Game Setup</h2>

      <!-- Timer -->
      <div class="control-section">
        <label class="control-label" for="timer-setting">Timer Duration</label>
        <div id="timer-controls">
          <button id="decrease-time" aria-label="Decrease time by 30 seconds">
            -
          </button>
          <span id="timer-setting">01:00</span>
          <button id="increase-time" aria-label="Increase time by 30 seconds">
            +
          </button>
        </div>
      </div>

      <!-- Generation Selection -->
      <div class="control-section">
        <div id="generation-controls-header">
          <label class="control-label">Generations</label>
          <div id="generation-buttons">
            <button id="randomize-gens-button">Randomize</button>
            <button id="select-all-gens-button">Deselect All</button>
          </div>
        </div>
        <div id="random-gen-status">Generations will be chosen randomly!</div>
        <div id="generation-selector">
          <!-- Checkboxes will be populated by JS -->
        </div>
      </div>

      <!-- Options -->
      <div class="control-section">
        <label class="control-label">Options</label>
        <div style="display: flex; flex-direction: column; gap: 10px">
          <div class="checkbox-option" id="cry-controls">
            <input type="checkbox" id="play-cry-checkbox" name="play-cry" />
            <label for="play-cry-checkbox">Play Pokémon Cry</label>
          </div>
          <div class="checkbox-option" id="autocomplete-controls">
            <input
              type="checkbox"
              id="autocomplete-checkbox"
              name="autocomplete"
              checked
            />
            <label for="autocomplete-checkbox">Enable Autocomplete</label>
          </div>
          <div class="checkbox-option" id="dex-number-controls">
            <input
              type="checkbox"
              id="show-dex-number-checkbox"
              name="show-dex-number"
            />
            <label for="show-dex-number-checkbox">Show Dex Number Hint</label>
            <!-- Updated Label -->
          </div>
        </div>
      </div>

      <button id="start-game" disabled>Loading Pokémon Data...</button>
      <p id="loading-names">Fetching Pokémon list...</p>
    </div>

    <div id="game-container">
      <div id="status-display">
        <div id="timer-area">Time: <span id="time-left">00:00</span></div>
        <div id="score-area">
          Score: <span id="correct-count">0</span> /
          <span id="incorrect-count" class="incorrect">0</span>
        </div>
      </div>

      <div id="pokemon-display">
        <p id="loading">Loading Pokémon...</p>
        <img
          id="pokemon-image"
          src=""
          alt="Pokémon Silhouette"
          class="hidden"
        />
      </div>
      <div id="guess-area">
        <input
          type="text"
          id="pokemon-guess"
          placeholder="Enter Pokémon name..."
          autocomplete="off"
        />
        <ul id="autocomplete-list"></ul>
      </div>
      <div id="dex-hint"></div>
      <!-- Element for Dex Hint -->
      <div id="feedback">Guess the Pokémon!</div>

      <!-- Action Buttons Container -->
      <div id="game-actions">
        <button id="skip-pokemon">Skip</button>
        <button id="next-pokemon">Next Pokémon</button>
      </div>

      <!-- Controls shown after game end -->
      <div id="endgame-controls" style="display: flex">
        <!-- Use inline style temporarily if needed, or add class -->
        <button id="restart-game">Restart Game</button>
        <button id="return-to-setup">Change Settings</button>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        // Define Generation Ranges (inclusive) - Updated for Gen 9 DLC
        const generationRanges = {
          1: { start: 1, end: 151, name: "Gen 1" },
          2: { start: 152, end: 251, name: "Gen 2" },
          3: { start: 252, end: 386, name: "Gen 3" },
          4: { start: 387, end: 493, name: "Gen 4" },
          5: { start: 494, end: 649, name: "Gen 5" },
          6: { start: 650, end: 721, name: "Gen 6" },
          7: { start: 722, end: 809, name: "Gen 7" },
          8: { start: 810, end: 905, name: "Gen 8" }, // Includes Hisui
          9: { start: 906, end: 1025, name: "Gen 9" }, // Includes Paldea + Kitakami + Blueberry
        };
        const LATEST_POKEMON_ID = 1025; // Current max National Dex number
        const ALL_GEN_KEYS = Object.keys(generationRanges).map(Number); // Array of [1, 2, ..., 9]

        // Global Pokemon Data Store
        let allPokemonData = []; // Will store { name: string, id: number } for all fetched Pokemon

        // Game State Variables
        let availablePokemonIds = []; // IDs for the current game based on selected generations
        let selectedPokemonNames = []; // Names corresponding to availablePokemonIds for autocomplete
        let totalSelectedPokemon = 0; // Count of Pokemon in selected generations

        let currentPokemonName = "";
        let currentPokemonImageUrl = "";
        let currentPokemonCryUrl = "";
        let currentPokemonId = null;
        let guessedPokemonIds = new Set();

        let correctCount = 0;
        let incorrectCount = 0;
        let firstIncorrectGuessMade = false;

        let timerInterval = null;
        let timerDuration = 60; // Default 1 minute
        let timeLeft = 0;

        // Game Settings
        let playCryEnabled = false;
        let autocompleteEnabled = true;
        let showDexNumberEnabled = false; // Default off for Dex Number
        let randomGenerationsActive = false; // Flag for random generation mode
        let randomlySelectedGens = []; // Stores randomly chosen generation keys

        let gameIsActive = false;
        let roundActive = false;

        let highlightedAutocompleteIndex = -1;

        // Preloading Variables
        let preloadedPokemonData = null; // Stores {id, name, imageUrl, cryUrl}
        let isPreloading = false; // Flag to prevent concurrent preloads

        // --- Utility Functions ---
        function formatTime(seconds) {
          const minutes = Math.floor(seconds / 60);
          const remainingSeconds = seconds % 60;
          return `${minutes
            .toString()
            .padStart(2, "0")}:${remainingSeconds.toString().padStart(2, "0")}`;
        }

        function updateTimerDisplay() {
          $("#time-left").text(formatTime(timeLeft));
        }

        function updateScoreDisplay() {
          $("#correct-count").text(correctCount);
          $("#incorrect-count").text(incorrectCount);
        }

        function revealPokemon(showFeedback = true) {
          $("#pokemon-image").removeClass("silhouette hidden"); // Reveal by removing silhouette and hidden
          if (showFeedback) {
            // Add dex number to feedback on reveal (optional, but good confirmation)
            const dexNumText = showDexNumberEnabled
              ? ` (#${currentPokemonId})`
              : "";
            $("#feedback").html(
              `${displayPokemonName(
                currentPokemonName
              )}<span class="dex-number">${dexNumText}</span>`
            ); // Use .html() to render span
          }
          // Ensure hint is cleared AFTER reveal if it wasn't already
          $("#dex-hint").hide().text("");
        }

        function normalizeName(name) {
          // Handles most cases including Nidoran♀/♂, forms like meowth-galar, etc.
          // It also handles names with spaces like 'Mr. Mime' becoming 'mr-mime' from PokeAPI
          if (!name) return "";
          return name
            .toLowerCase()
            .trim()
            .replace(/\s+/g, "-") // Replace spaces with hyphens
            .replace(/[^a-z0-9-]+/g, "") // Remove invalid characters (like periods, apostrophes)
            .replace(/[\u2640\u2642]/g, ""); // Remove female/male symbols if present in input
        }

        function displayPokemonName(name) {
          // Capitalize, handle hyphens, and specific cases like Nidoran/Mr. Mime
          if (!name) return "";
          let displayName = name
            .replace(/-/g, " ") // Replace hyphens with spaces for display
            .replace(" f", "♀") // Handle nidoran-f specifically
            .replace(" m", "♂"); // Handle nidoran-m specifically

          // Capitalize each part of the name (e.g., "Mr Mime", "Ho Oh")
          displayName = displayName
            .split(" ")
            .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
            .join(" ");

          // Handle specific overrides if needed (e.g., Farfetch'd)
          if (name === "farfetchd") displayName = "Farfetch'd";
          if (name === "mr-mime") displayName = "Mr. Mime";
          if (name === "mime-jr") displayName = "Mime Jr.";
          if (name === "type-null") displayName = "Type: Null";
          if (
            name === "jangmo-o" ||
            name === "hakamo-o" ||
            name === "kommo-o"
          ) {
            displayName = displayName.replace(" O", "-o"); // Handle the -o Pokemon
          }
          if (name.startsWith("porygon")) {
            // Handle Porygon2 and Porygon-Z
            if (name === "porygon2") displayName = "Porygon2";
            if (name === "porygon-z") displayName = "Porygon-Z";
          }
          if (
            name === "tapu-koko" ||
            name === "tapu-lele" ||
            name === "tapu-bulu" ||
            name === "tapu-fini"
          )
            displayName = displayName.replace("Tapu ", "Tapu "); // Ensure space after Tapu

          return displayName;
        }

        function playSound(url) {
          if (url) {
            try {
              const audio = new Audio(url);
              audio.volume = 0.3; // Lower volume
              audio
                .play()
                .catch((e) => console.error("Error playing sound:", e));
            } catch (e) {
              console.error("Error creating audio element:", e);
            }
          }
        }

        // --- Fetch All Pokemon Names on Load ---
        function fetchAllPokemonNames() {
          $("#loading-names").show();
          $("#start-game")
            .text("Loading Pokémon Data...")
            .prop("disabled", true);
          $.getJSON(
            `https://pokeapi.co/api/v2/pokemon?limit=${LATEST_POKEMON_ID}&offset=0`,
            function (data) {
              allPokemonData = data.results.map((p) => {
                const urlParts = p.url.split("/");
                const id = parseInt(urlParts[urlParts.length - 2]);
                return { name: p.name, id: id };
              });
              // Filter out potential null/invalid entries if any - ensure ID is within known range
              allPokemonData = allPokemonData.filter(
                (p) => p.id > 0 && p.id <= LATEST_POKEMON_ID
              );
              console.log(`Fetched ${allPokemonData.length} Pokémon names.`);
              $("#start-game").text("Start Game").prop("disabled", false);
              $("#loading-names").hide();
              // Call updateSelectAllButtonText here AFTER data is loaded to check start button status correctly
              updateSelectAllButtonText();
            }
          ).fail(function (jqXHR, textStatus, errorThrown) {
            console.error(
              "Failed to fetch Pokémon list:",
              textStatus,
              errorThrown
            );
            $("#loading-names")
              .text("Error loading Pokémon list. Please refresh.")
              .show();
            $("#start-game").text("Error").prop("disabled", true);
          });
        }

        // --- Populate Generation Checkboxes ---
        function populateGenerationCheckboxes() {
          const $selector = $("#generation-selector");
          $selector.empty(); // Clear previous checkboxes if any
          Object.keys(generationRanges).forEach((genKey) => {
            const genInfo = generationRanges[genKey];
            const checkboxId = `gen-${genKey}-checkbox`;
            // Check ALL generations by default
            const isChecked = true;
            $selector.append(`
              <label for="${checkboxId}" class="gen-checkbox-label">
                  <input type="checkbox" id="${checkboxId}" name="generation" value="${genKey}" ${
              isChecked ? "checked" : ""
            }>
                  ${genInfo.name}
              </label>
            `);
          });
          // Update select/deselect button text based on initial state
          // updateSelectAllButtonText(); // Delay this call until Pokemon data is loaded
          // Ensure random mode UI is off initially
          setRandomGenerationMode(false);
        }

        // --- Generation Selection Button Logic ---
        function updateSelectAllButtonText() {
          // Only proceed if generation checkboxes are populated
          const $genCheckboxes = $(
            "#generation-selector input[type='checkbox']"
          );
          if ($genCheckboxes.length === 0) return; // Avoid errors if called too early

          const allChecked =
            $genCheckboxes.length === $genCheckboxes.filter(":checked").length;
          $("#select-all-gens-button").text(
            allChecked ? "Deselect All" : "Select All"
          );

          // Enable/disable start button based on selection (only if not in random mode)
          // AND only if pokemon data has actually loaded
          const dataLoaded = allPokemonData.length > 0;
          if (!randomGenerationsActive) {
            const anyChecked = $genCheckboxes.filter(":checked").length > 0;
            $("#start-game").prop("disabled", !anyChecked || !dataLoaded);
          } else {
            // In random mode, start is always possible once data is loaded
            $("#start-game").prop("disabled", !dataLoaded);
          }

          // Update button text after data load if needed
          if (!dataLoaded && !$("#start-game").prop("disabled")) {
            $("#start-game")
              .text("Loading Pokémon Data...")
              .prop("disabled", true);
          } else if (
            dataLoaded &&
            $("#start-game").prop("disabled") &&
            (randomGenerationsActive ||
              $genCheckboxes.filter(":checked").length > 0)
          ) {
            $("#start-game").text("Start Game").prop("disabled", false);
          } else if (
            dataLoaded &&
            !$("#start-game").prop("disabled") &&
            !randomGenerationsActive &&
            $genCheckboxes.filter(":checked").length === 0
          ) {
            $("#start-game").prop("disabled", true); // Disable if data loaded, manual mode, but nothing selected
          }
        }

        $("#select-all-gens-button").on("click", function () {
          if (randomGenerationsActive) return; // Don't allow if random mode is on

          const $genCheckboxes = $(
            "#generation-selector input[type='checkbox']"
          );
          const allChecked =
            $genCheckboxes.length > 0 &&
            $genCheckboxes.length === $genCheckboxes.filter(":checked").length;
          $genCheckboxes.prop("checked", !allChecked);
          updateSelectAllButtonText(); // Update button text and potentially start button state
        });

        // Also update button text if a user manually clicks a checkbox
        $("#generation-selector").on(
          "change",
          "input[type='checkbox']",
          function () {
            if (randomGenerationsActive) return; // Ignore clicks if random mode is on
            updateSelectAllButtonText();
          }
        );

        // --- Randomize Generations Button Logic ---
        function setRandomGenerationMode(isActive) {
          randomGenerationsActive = isActive;
          if (isActive) {
            $("#generation-selector").hide();
            $("#select-all-gens-button").hide();
            $("#random-gen-status").show();
            $("#randomize-gens-button").text("Select Manually");

            // Perform the randomization
            randomlySelectedGens = [];
            const numGensToSelect =
              Math.floor(Math.random() * ALL_GEN_KEYS.length) + 1; // 1 to 9 gens
            const availableGens = [...ALL_GEN_KEYS];
            for (let i = 0; i < numGensToSelect; i++) {
              const randomIndex = Math.floor(
                Math.random() * availableGens.length
              );
              randomlySelectedGens.push(
                availableGens.splice(randomIndex, 1)[0]
              );
            }
            console.log(
              "Randomly selected generations (hidden):",
              randomlySelectedGens.sort((a, b) => a - b)
            );
            //$("#start-game").prop("disabled", allPokemonData.length === 0); // Enable start if data ready // Handled by updateSelectAllButtonText now
          } else {
            $("#generation-selector").show();
            $("#select-all-gens-button").show();
            $("#random-gen-status").hide();
            $("#randomize-gens-button").text("Randomize");
            randomlySelectedGens = [];
            // Reset checkboxes to all selected when returning to manual
            $("#generation-selector input[type='checkbox']").prop(
              "checked",
              true
            );
            // updateSelectAllButtonText(); // Update button text and check start button state // Handled below
          }
          // Always update start button state after changing mode
          updateSelectAllButtonText();
        }

        $("#randomize-gens-button").on("click", function () {
          setRandomGenerationMode(!randomGenerationsActive); // Toggle the mode
        });

        // --- Timer Controls ---
        $("#increase-time").on("click", function () {
          if (!gameIsActive) {
            timerDuration += 30;
            $("#timer-setting").text(formatTime(timerDuration));
          }
        });

        $("#decrease-time").on("click", function () {
          if (!gameIsActive && timerDuration > 30) {
            timerDuration -= 30;
            $("#timer-setting").text(formatTime(timerDuration));
          }
        });

        // --- Game State Functions ---
        function initGame() {
          gameIsActive = false;
          roundActive = false;
          stopTimer();
          correctCount = 0;
          incorrectCount = 0;
          guessedPokemonIds.clear();
          highlightedAutocompleteIndex = -1;
          availablePokemonIds = [];
          selectedPokemonNames = [];
          totalSelectedPokemon = 0;
          // randomlySelectedGens = []; // Clearing this here might interfere if user clicks Setup then Start quickly in random mode? Let's clear in startGame instead.
          preloadedPokemonData = null; // Clear preloaded data
          isPreloading = false; // Reset preload flag

          $("#controls-container").show();
          $("#game-container").hide();
          $("#endgame-controls").hide(); // Ensure endgame controls are hidden
          $("#timer-controls button").prop("disabled", false);

          // Enable all setup controls
          $("#controls-container input, #controls-container button").prop(
            "disabled",
            false
          );

          // Reset options to defaults (do this before resetting gen mode)
          $("#play-cry-checkbox").prop("checked", false);
          $("#autocomplete-checkbox").prop("checked", true);
          $("#show-dex-number-checkbox").prop("checked", false);

          // Reset generation selection UI to default (manual, all checked)
          // This also calls updateSelectAllButtonText which handles start button state based on data loaded status
          setRandomGenerationMode(false);

          // Reset timer display to configured duration
          $("#timer-setting").text(formatTime(timerDuration));
          updateScoreDisplay();

          $("#pokemon-guess").val("").prop("disabled", true);
          $("#feedback")
            .text("Guess the Pokémon!")
            .removeClass("correct incorrect info");
          $("#dex-hint").hide().text(""); // Hide dex hint
          // Reset image state: hidden, NO silhouette, NO src
          $("#pokemon-image")
            .removeClass("silhouette")
            .addClass("hidden")
            .attr("src", "");
          $("#loading").show().text("Loading Pokémon..."); // Show loading text in the image area initially
          $("#autocomplete-list").hide().empty();
          $("#next-pokemon").hide();
          $("#skip-pokemon").hide().prop("disabled", false); // Also hide skip button
        }

        function startGame() {
          // --- Determine Selected Generations and Filter Pokemon ---
          availablePokemonIds = [];
          selectedPokemonNames = [];
          randomlySelectedGens = []; // Clear previous random selection if any
          let selectedGenerations = [];

          if (randomGenerationsActive) {
            // Need to re-randomize if user clicked 'Start Game' in random mode
            const numGensToSelect =
              Math.floor(Math.random() * ALL_GEN_KEYS.length) + 1; // 1 to 9 gens
            const availableGens = [...ALL_GEN_KEYS];
            for (let i = 0; i < numGensToSelect; i++) {
              const randomIndex = Math.floor(
                Math.random() * availableGens.length
              );
              randomlySelectedGens.push(
                availableGens.splice(randomIndex, 1)[0]
              );
            }
            selectedGenerations = randomlySelectedGens;

            if (selectedGenerations.length === 0) {
              alert(
                "Error: No generations were randomly selected. Please try again."
              );
              // Revert to manual mode on error
              setRandomGenerationMode(false);
              return;
            }
            console.log(
              "Starting game with NEW randomly selected generations:",
              selectedGenerations.sort((a, b) => a - b).join(", ")
            );
            // Update status text for clarity (optional)
            $("#random-gen-status").text(
              `Generations chosen: ${selectedGenerations.length} (Random)`
            );
          } else {
            selectedGenerations = $("#generation-selector input:checked")
              .map(function () {
                return parseInt($(this).val());
              })
              .get();

            if (selectedGenerations.length === 0) {
              alert("Please select at least one generation!");
              return; // Stop if no generations are selected
            }
            console.log(
              `Starting game manually with generations: ${selectedGenerations.join(
                ", "
              )}`
            );
          }

          // Filter Pokemon based on selectedGenerations
          selectedGenerations.forEach((genKey) => {
            const range = generationRanges[genKey];
            if (!range) {
              console.warn(`Invalid generation key found: ${genKey}`);
              return; // Skip invalid gen key
            }
            const genPokemon = allPokemonData.filter(
              (p) => p.id >= range.start && p.id <= range.end
            );
            genPokemon.forEach((p) => {
              if (!availablePokemonIds.includes(p.id)) {
                availablePokemonIds.push(p.id);
                selectedPokemonNames.push(p.name); // Store names for autocomplete
              }
            });
          });

          if (availablePokemonIds.length === 0) {
            alert(
              "No Pokémon could be loaded for the selected generations. Please check the data or selection."
            );
            // Re-enable relevant controls if needed (should be handled by initGame/setRandomGenMode)
            return;
          }

          totalSelectedPokemon = availablePokemonIds.length;
          console.log(`Total Pokémon for this game: ${totalSelectedPokemon}`);

          // --- Reset Game State ---
          gameIsActive = true;
          roundActive = false; // Will be set true when pokemon loads
          correctCount = 0;
          incorrectCount = 0;
          guessedPokemonIds.clear();
          preloadedPokemonData = null; // Clear preload cache
          isPreloading = false;
          updateScoreDisplay();

          // --- Read Settings ---
          playCryEnabled = $("#play-cry-checkbox").is(":checked");
          autocompleteEnabled = $("#autocomplete-checkbox").is(":checked");
          showDexNumberEnabled = $("#show-dex-number-checkbox").is(":checked");

          // --- Update UI ---
          $("#controls-container").hide();
          $("#game-container").show();
          $("#endgame-controls").hide(); // Make sure endgame controls are hidden

          // Disable setup controls during game
          $("#timer-controls button").prop("disabled", true);
          //$("#controls-container input, #controls-container button").prop("disabled", true); // Keep setup buttons disabled

          $("#feedback")
            .text("Guess the Pokémon!")
            .removeClass("correct incorrect info");
          $("#dex-hint").hide().text(""); // Hide dex hint initially
          $("#skip-pokemon").hide(); // Hide skip initially
          $("#next-pokemon").hide(); // Hide next initially
          // Prepare image area: loading text visible, image element hidden & cleared
          $("#loading").show().text("Loading Pokémon...");
          $("#pokemon-image")
            .addClass("hidden")
            .removeClass("silhouette")
            .attr("src", "");

          timeLeft = timerDuration;
          updateTimerDisplay();
          startTimer();
          loadPokemon(); // Load the first Pokemon
        }

        function endGame(reason) {
          gameIsActive = false;
          roundActive = false;
          stopTimer();
          preloadedPokemonData = null; // Clear preload cache
          isPreloading = false;

          $("#pokemon-guess").prop("disabled", true);
          $("#next-pokemon").hide();
          $("#skip-pokemon").hide().prop("disabled", true); // Hide and disable skip on game end
          $("#autocomplete-list").hide();
          $("#dex-hint").hide().text(""); // Hide dex hint on game end

          if (currentPokemonImageUrl && currentPokemonName) {
            // Ensure we have a Pokemon loaded before revealing
            revealPokemon(false); // Show the last Pokemon without feedback text override here
          } else {
            // If no Pokemon was loaded (e.g., time runs out instantly)
            $("#pokemon-image")
              .addClass("hidden")
              .removeClass("silhouette")
              .attr("src", ""); // Hide placeholder/loading
            $("#loading").hide(); // Hide loading text
          }

          const finalMessageBase = `Final Score: ${correctCount} Correct, ${incorrectCount} Incorrect out of ${
            correctCount + incorrectCount
          } viewed Pokémon.`;
          let feedbackText = "";

          if (reason === "timeup") {
            feedbackText = `Time's Up! ${finalMessageBase}`;
          } else if (reason === "complete") {
            feedbackText = `Congratulations! You guessed all ${totalSelectedPokemon} selected Pokémon! ${finalMessageBase}`;
          } else {
            // Generic end game message (though usually timeup or complete)
            feedbackText = `Game Over! ${finalMessageBase}`;
          }

          // Reveal last Pokemon name in feedback if one was loaded
          if (currentPokemonName) {
            const dexNumText = showDexNumberEnabled
              ? ` (#${currentPokemonId})`
              : "";
            feedbackText += `<br>Last Pokémon was: ${displayPokemonName(
              currentPokemonName
            )}<span class="dex-number">${dexNumText}</span>`;
          }

          $("#feedback")
            .html(feedbackText) // Use html() for potential line break
            .removeClass("correct incorrect")
            .addClass("info");
          $("#endgame-controls").show().css("display", "flex"); // Show and ensure flex display
        }

        function startTimer() {
          if (timerInterval) clearInterval(timerInterval);
          timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
              endGame("timeup");
            }
          }, 1000);
        }

        function stopTimer() {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        // --- Pokémon Loading & Preloading ---

        // Function to display the loaded Pokémon (either fetched or preloaded)
        function displayLoadedPokemon(pokemonData) {
          currentPokemonName = pokemonData.name;
          currentPokemonId = pokemonData.id;
          currentPokemonImageUrl = pokemonData.imageUrl;
          currentPokemonCryUrl = pokemonData.cryUrl;

          // Add to guessed *only after* deciding to display it
          guessedPokemonIds.add(currentPokemonId);

          // Simple check if the image URL looks valid (basic)
          if (
            !currentPokemonImageUrl ||
            typeof currentPokemonImageUrl !== "string"
          ) {
            console.warn(
              `Missing or invalid image URL for ${currentPokemonName} (ID: ${currentPokemonId}). Using fallback sprite: ${pokemonData.fallbackImageUrl}`
            );
            currentPokemonImageUrl = pokemonData.fallbackImageUrl;
            if (!currentPokemonImageUrl) {
              console.error(
                `No valid image found for ${currentPokemonName}. Skipping.`
              );
              $("#loading").show().text("Image error. Loading another...");
              // Do NOT trigger preload here, as the current one failed. Try loading next directly.
              setTimeout(loadPokemon, 1500);
              return; // Stop processing this Pokémon
            }
          }

          // Preload image in memory before showing silhouette
          $("<img>")
            .attr("src", currentPokemonImageUrl)
            .on("load", function () {
              // Double-check if the game is still active and this is the intended pokemon ID
              if (gameIsActive && currentPokemonId === pokemonData.id) {
                $(this).remove(); // Clean up the preloader img element

                // *** KEY CHANGE FOR SILHOUETTE FLASH ***
                // Set the source, ensure silhouette class is present, THEN remove hidden class
                $("#pokemon-image")
                  .attr("src", currentPokemonImageUrl) // Set the source
                  .addClass("silhouette") // Ensure silhouette style is applied
                  .removeClass("hidden"); // NOW make it visible

                $("#loading").hide(); // Hide the "Loading..." text
                $("#pokemon-guess").prop("disabled", false).focus();
                $("#feedback").text("Guess the Pokémon!");

                roundActive = true;
                $("#skip-pokemon").show().prop("disabled", false); // Show and enable skip button

                // Display Dex Number Hint if enabled
                if (showDexNumberEnabled) {
                  $("#dex-hint")
                    .text(`Hint: National Dex #${currentPokemonId}`)
                    .show();
                } else {
                  $("#dex-hint").hide().text("");
                }

                if (playCryEnabled) {
                  // Play cry slightly after image appears
                  setTimeout(() => playSound(currentPokemonCryUrl), 100);
                }

                // --- Trigger Preloading for the NEXT Pokemon ---
                triggerPreload();
                // -----------------------------------------------
              } else {
                console.log(
                  "Game state changed during image preload or ID mismatch. Aborting display."
                );
                $(this).remove(); // Clean up if game state changed or wrong pokemon loaded
                // Do not trigger preload if display aborted
              }
            })
            .on("error", function () {
              $(this).remove();
              if (gameIsActive && currentPokemonId === pokemonData.id) {
                console.error(
                  `Error loading image for ${currentPokemonName} (ID: ${currentPokemonId}): ${currentPokemonImageUrl}`
                );
                $("#loading").show().text("Image error. Loading another...");
                // Do NOT trigger preload here, as the current one failed. Try loading next directly.
                setTimeout(loadPokemon, 1500);
              } else {
                console.log(
                  "Image load error for an old request or game not active."
                );
              }
            });
        }

        function loadPokemon() {
          if (!gameIsActive) return;

          // Check if all selected Pokemon have been guessed
          const remainingPokemonCount =
            totalSelectedPokemon - guessedPokemonIds.size;
          if (remainingPokemonCount <= 0 && totalSelectedPokemon > 0) {
            // Add check for totalSelectedPokemon > 0
            // Double check just in case
            const anyLeft = availablePokemonIds.some(
              (id) => !guessedPokemonIds.has(id)
            );
            if (!anyLeft) {
              endGame("complete");
              return;
            } else {
              console.warn(
                "Guessed count reached total, but unguessed IDs still available."
              );
              // Attempt to find an unguessed ID just in case state is inconsistent
              const unguessed = availablePokemonIds.find(
                (id) => !guessedPokemonIds.has(id)
              );
              if (!unguessed) {
                console.error(
                  "Inconsistent state: No unguessed ID found despite mismatch. Ending game."
                );
                endGame("complete"); // End game if truly none left
                return;
              }
              // If found, continue, but log the warning
              console.log("Proceeding despite count mismatch.");
            }
          }

          roundActive = false;
          firstIncorrectGuessMade = false;
          // *** KEY CHANGE FOR SILHOUETTE FLASH ***
          // Prepare the image element: hide it, remove silhouette (will be added back before showing), clear src
          $("#pokemon-image")
            .addClass("hidden")
            .removeClass("silhouette")
            .attr("src", "");
          $("#loading").show().text("Loading Pokémon..."); // Show loading text
          $("#feedback").text("").removeClass("correct incorrect info");
          $("#dex-hint").hide().text(""); // Hide hint while loading
          $("#pokemon-guess").val("").prop("disabled", true);
          $("#autocomplete-list").hide().empty();
          $("#next-pokemon").hide();
          $("#skip-pokemon").hide().prop("disabled", true); // Hide skip until loaded
          highlightedAutocompleteIndex = -1;
          // Don't reset currentPokemon data here yet, wait until successful load

          // --- Check for Preloaded Data ---
          if (
            preloadedPokemonData &&
            !guessedPokemonIds.has(preloadedPokemonData.id)
          ) {
            console.log(
              `Using preloaded data for: ${preloadedPokemonData.name} (#${preloadedPokemonData.id})`
            );
            const dataToDisplay = preloadedPokemonData;
            preloadedPokemonData = null; // Consume the preloaded data
            displayLoadedPokemon(dataToDisplay); // Display this Pokémon
          } else {
            // --- No Valid Preload Data: Fetch New Pokemon ---
            if (
              preloadedPokemonData &&
              guessedPokemonIds.has(preloadedPokemonData.id)
            ) {
              console.log(
                `Preloaded data for #${preloadedPokemonData.id} was already guessed. Fetching new.`
              );
              preloadedPokemonData = null; // Discard stale preload data
            }

            let randomId;
            let attempts = 0;
            const maxAttempts = availablePokemonIds.length * 2 + 10;

            // Ensure availablePokemonIds is not empty before trying to pick one
            if (availablePokemonIds.length === 0) {
              console.error(
                "loadPokemon called with no available Pokémon IDs. This shouldn't happen."
              );
              // Potentially end game or show an error
              endGame("error"); // Or some other appropriate state
              return;
            }

            do {
              const randomIndex = Math.floor(
                Math.random() * availablePokemonIds.length
              );
              randomId = availablePokemonIds[randomIndex];
              attempts++;
              // Ensure we have IDs left to choose from
            } while (
              guessedPokemonIds.has(randomId) &&
              attempts < maxAttempts &&
              guessedPokemonIds.size < availablePokemonIds.length
            );

            if (guessedPokemonIds.has(randomId)) {
              // If the loop finished because it was guessed or max attempts reached
              console.warn(
                `Failed to find random unguessed ID after ${attempts} attempts or last one was guessed. Searching sequentially.`
              );
              const unguessed = availablePokemonIds.find(
                (id) => !guessedPokemonIds.has(id)
              );
              if (unguessed !== undefined) {
                randomId = unguessed;
                console.log(`Found unguessed ID sequentially: ${randomId}`);
              } else {
                console.error(
                  "Could not find any unguessed Pokemon ID even sequentially. Ending game."
                );
                endGame("complete"); // Assume completion if sequential search fails
                return;
              }
            }

            const apiUrl = `https://pokeapi.co/api/v2/pokemon/${randomId}`;
            console.log(`Fetching data for Pokémon ID: ${randomId}`);

            $.getJSON(apiUrl)
              .done(function (data) {
                if (!gameIsActive) return; // Check if game ended while fetching

                const fetchedData = {
                  id: data.id,
                  name: data.name,
                  imageUrl:
                    data.sprites.other?.["official-artwork"]?.front_default ||
                    data.sprites.front_default,
                  cryUrl: data.cries?.latest || data.cries?.legacy || "",
                  fallbackImageUrl: data.sprites.front_default, // Store fallback separately in case primary fails
                };

                displayLoadedPokemon(fetchedData); // Display the fetched Pokémon
              })
              .fail(function (jqXHR, textStatus, errorThrown) {
                if (gameIsActive) {
                  console.error(
                    "PokeAPI fetch failed:",
                    textStatus,
                    errorThrown,
                    `for ID: ${randomId}`
                  );
                  $("#loading")
                    .show()
                    .text("Error loading Pokémon data. Retrying..."); // Keep loading indicator
                  // Do not trigger preload on failure
                  setTimeout(loadPokemon, 3000); // Retry loading current one
                }
              });
          }
        }

        // Function to trigger preloading the next Pokemon
        function triggerPreload() {
          if (!gameIsActive || isPreloading) return;

          const remainingPokemonCount =
            totalSelectedPokemon - guessedPokemonIds.size;
          // Don't preload if only the current one is left, or if already preloading.
          // Change to <= 0 as we load the *next* one (current one is already displayed)
          if (remainingPokemonCount <= 0) {
            console.log("Preload skipped: No remaining Pokémon.");
            return;
          }
          if (isPreloading) {
            console.log(
              "Preload skipped: Another preload is already in progress."
            );
            return;
          }

          isPreloading = true;
          let preloadId;
          let attempts = 0;
          const maxAttempts = availablePokemonIds.length * 2 + 10; // Safety limit

          // Ensure there are actually IDs left to choose from for preloading
          const potentialPreloadIds = availablePokemonIds.filter(
            (id) => !guessedPokemonIds.has(id) && id !== currentPokemonId
          );
          if (potentialPreloadIds.length === 0) {
            console.log("Preload: No suitable Pokémon found to preload.");
            isPreloading = false;
            return;
          }

          // Find a random, unguessed ID that is *different* from the current one
          do {
            const randomIndex = Math.floor(
              Math.random() * potentialPreloadIds.length
            );
            preloadId = potentialPreloadIds[randomIndex];
            // No need for attempt counter here since we filtered the list first
            // The loop condition is just to handle the unlikely case potentialPreloadIds was empty (already checked above)
          } while (!preloadId && potentialPreloadIds.length > 0);

          // If somehow preloadId is still undefined (shouldn't happen with the check above)
          if (!preloadId) {
            console.warn(
              "Preload: Failed to select a preload ID from potential candidates."
            );
            isPreloading = false;
            return;
          }

          const preloadApiUrl = `https://pokeapi.co/api/v2/pokemon/${preloadId}`;
          console.log(`Preloading data for Pokémon ID: ${preloadId}`);

          $.getJSON(preloadApiUrl)
            .done(function (data) {
              // Store minimal needed data
              preloadedPokemonData = {
                id: data.id,
                name: data.name,
                imageUrl:
                  data.sprites.other?.["official-artwork"]?.front_default ||
                  data.sprites.front_default,
                cryUrl: data.cries?.latest || data.cries?.legacy || "",
                fallbackImageUrl: data.sprites.front_default,
              };
              console.log(
                `Successfully preloaded: ${preloadedPokemonData.name} (#${preloadedPokemonData.id})`
              );

              // Optional: Preload image asset in browser cache
              if (preloadedPokemonData.imageUrl) {
                const img = new Image();
                img.src = preloadedPokemonData.imageUrl;
              }
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
              console.error(
                "Preload failed:",
                textStatus,
                errorThrown,
                `for ID: ${preloadId}`
              );
              preloadedPokemonData = null; // Clear preload data on failure
            })
            .always(function () {
              isPreloading = false; // Allow next preload attempt
            });
        }

        // --- Autocomplete Logic ---
        $("#pokemon-guess").on("input", function () {
          if (!roundActive || !autocompleteEnabled) {
            $("#autocomplete-list").empty().hide();
            return;
          }

          const inputText = normalizeName($(this).val()); // Use normalizeName for input matching
          const $autocompleteList = $("#autocomplete-list");
          $autocompleteList.empty().hide();
          highlightedAutocompleteIndex = -1;

          if (inputText.length === 0) {
            return;
          }

          // Filter selectedPokemonNames (which contains the normalized names for the current game)
          const matches = selectedPokemonNames
            .filter((name) => name.startsWith(inputText))
            .sort(); // Sort matches alphabetically

          if (matches.length > 0) {
            // Limit number of suggestions shown
            matches.slice(0, 7).forEach((name, index) => {
              const displayName = displayPokemonName(name); // Use display function for showing
              const $li = $("<li></li>")
                .text(displayName)
                .attr("data-value", name) // Store the normalized name
                .data("index", index);
              $autocompleteList.append($li);
            });
            $autocompleteList.show();
          }
        });

        // Autocomplete Keyboard Navigation
        $("#pokemon-guess").on("keydown", function (event) {
          if (!roundActive || !autocompleteEnabled) return; // Also check autocompleteEnabled here

          const $list = $("#autocomplete-list");
          const listIsVisible = $list.is(":visible");
          const $items = $list.find("li");
          const itemsCount = $items.length;

          if (event.key === "Enter") {
            event.preventDefault(); // Prevent form submission/default action
            if (
              listIsVisible &&
              highlightedAutocompleteIndex !== -1 &&
              itemsCount > 0
            ) {
              $items.eq(highlightedAutocompleteIndex).trigger("click");
            } else {
              checkGuess(); // Check the typed guess if no suggestion selected
            }
            $list.hide(); // Always hide list on enter
            highlightedAutocompleteIndex = -1; // Reset highlight index
            return;
          }

          if (event.key === "Escape") {
            if (listIsVisible) {
              event.preventDefault();
              $list.hide();
              highlightedAutocompleteIndex = -1;
            }
            return;
          }

          // Only handle arrow keys if list is visible and has items
          if (!listIsVisible || itemsCount === 0) return;

          let previousIndex = highlightedAutocompleteIndex;

          switch (event.key) {
            case "ArrowDown":
            case "Tab": // Treat Tab like ArrowDown in the list
              event.preventDefault();
              highlightedAutocompleteIndex =
                (highlightedAutocompleteIndex + 1) % itemsCount;
              break;
            case "ArrowUp":
              event.preventDefault();
              highlightedAutocompleteIndex =
                (highlightedAutocompleteIndex - 1 + itemsCount) % itemsCount;
              break;
            default:
              return; // Ignore other keys for navigation purposes
          }

          // Only update highlight if index changed
          if (previousIndex !== highlightedAutocompleteIndex) {
            highlightAutocompleteItem($items);
          }
        });

        function highlightAutocompleteItem($items) {
          $items.removeClass("autocomplete-highlight");
          if (highlightedAutocompleteIndex !== -1) {
            const $currentItem = $items.eq(highlightedAutocompleteIndex);
            $currentItem.addClass("autocomplete-highlight");
            // Scroll into view logic
            const listElement = $("#autocomplete-list")[0];
            const itemElement = $currentItem[0];
            // Check if elements exist before trying to scroll
            if (
              itemElement &&
              listElement &&
              typeof itemElement.scrollIntoView === "function"
            ) {
              // Using 'nearest' should prevent excessive scrolling unless necessary
              itemElement.scrollIntoView({ block: "nearest" });
            }
          }
        }

        // --- Select Autocomplete Suggestion (Click) ---
        $("#autocomplete-list").on("click", "li", function () {
          if (!roundActive) return;
          const selectedName = $(this).attr("data-value"); // Get normalized name
          $("#pokemon-guess").val(displayPokemonName(selectedName)); // Display formatted name
          $("#autocomplete-list").hide().empty();
          highlightedAutocompleteIndex = -1;
          checkGuess(selectedName); // Check guess with the normalized name
          $("#pokemon-guess").focus(); // Refocus input after selection
        });

        // --- Hide Autocomplete on Click Outside ---
        $(document).on("click", function (event) {
          if (
            autocompleteEnabled &&
            !$(event.target).closest("#pokemon-guess, #autocomplete-list")
              .length
          ) {
            $("#autocomplete-list").hide();
            highlightedAutocompleteIndex = -1;
          }
        });

        // --- Check Guess Function ---
        function checkGuess(directGuess = null) {
          if (!roundActive || !gameIsActive) return;

          const userGuess = normalizeName(
            directGuess ? directGuess : $("#pokemon-guess").val()
          );
          const $feedback = $("#feedback");
          $("#autocomplete-list").hide(); // Ensure list is hidden after guess attempt

          if (!userGuess) {
            $feedback
              .text("Please enter a Pokémon name.")
              .removeClass("correct incorrect")
              .addClass("info");
            return;
          }

          // Use normalizeName for comparison as well
          const normalizedCurrentPokemonName =
            normalizeName(currentPokemonName);

          if (userGuess === normalizedCurrentPokemonName) {
            // Correct guess handling only if it wasn't already marked incorrect
            if (!firstIncorrectGuessMade) {
              correctCount++;
            } // Don't increment correct if they got it wrong first

            updateScoreDisplay();
            // Feedback confirms name, Dex number added by revealPokemon if needed
            // Basic correct message (revealPokemon will add Dex# if needed)
            $feedback
              .html(`Correct!`) // Keep it simple, revealPokemon adds the name
              .removeClass("incorrect info")
              .addClass("correct");
            revealPokemon(true); // Reveal image AND update feedback with Name + Dex# if needed
            $("#pokemon-guess").prop("disabled", true);
            $("#skip-pokemon").hide().prop("disabled", true); // Hide and disable skip
            $("#next-pokemon").show().focus(); // Show Next button and focus it
            roundActive = false; // End the round successfully
            $("#dex-hint").hide().text(""); // Hide hint on correct guess
          } else {
            // Incorrect guess
            if (!firstIncorrectGuessMade) {
              incorrectCount++;
              firstIncorrectGuessMade = true; // Mark that an incorrect guess has been made for this round
              updateScoreDisplay();
            }
            $feedback
              .text("Incorrect! Try again.")
              .removeClass("correct info")
              .addClass("incorrect");
            $("#pokemon-guess").select().focus(); // Select text and keep focus for easy re-entry
            // Keep hint visible if enabled
          }
        }

        // --- Handle "Skip Pokémon" Button Click ---
        $("#skip-pokemon").on("click", function () {
          if (!roundActive || !gameIsActive) return;

          // Mark as incorrect only if it wasn't already marked incorrect this round
          if (!firstIncorrectGuessMade) {
            incorrectCount++;
            // No need to set firstIncorrectGuessMade = true here, as the round ends immediately
            updateScoreDisplay();
          }

          roundActive = false; // End the round
          $("#pokemon-guess").prop("disabled", true);
          $("#skip-pokemon").hide().prop("disabled", true); // Hide and disable skip itself
          $("#autocomplete-list").hide();
          $("#dex-hint").hide().text(""); // Hide hint on skip

          // Reveal the answer
          const dexNumText = showDexNumberEnabled
            ? ` (#${currentPokemonId})`
            : "";
          $("#feedback")
            .html(
              `Skipped! It was ${displayPokemonName(
                currentPokemonName
              )}<span class="dex-number">${dexNumText}</span>`
            )
            .removeClass("correct")
            .addClass("info incorrect"); // Style as info/skipped, potentially also incorrect styling
          revealPokemon(false); // Reveal image (feedback already set)

          // Show the next button instead of auto-loading
          $("#next-pokemon").show().focus();
        });

        // --- Handle "Next Pokémon" Button Click ---
        $("#next-pokemon").on("click", function () {
          if (gameIsActive) {
            loadPokemon(); // Load the next Pokemon (will use preload if available)
          }
        });

        // --- Handle Start/Restart/Setup Button Clicks ---
        $("#start-game").on("click", startGame);
        $("#restart-game").on("click", startGame); // Restart uses the same startGame logic
        $("#return-to-setup").on("click", initGame);

        // --- Initial Setup ---
        populateGenerationCheckboxes(); // Add generation checkboxes to the DOM
        initGame(); // Set up the initial screen state (calls setRandomGenerationMode, which calls updateSelectAllButtonText)
        fetchAllPokemonNames(); // Start fetching all names immediately (will enable start button via callback)
      });
    </script>
  </body>
</html>
