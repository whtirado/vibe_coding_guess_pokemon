<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Who's That Pokémon? (Gen 1)</title>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        text-shadow: 1px 1px 2px #aaa;
      }

      #controls-container,
      #game-container {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 400px;
        width: 100%;
        margin-bottom: 15px;
      }

      #game-container {
        /* Initially hidden until game starts */
        display: none;
      }

      #timer-controls button {
        padding: 5px 10px;
        font-size: 1.2em;
        margin: 0 5px;
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #eee;
        border-radius: 4px;
      }
      #timer-controls span {
        font-size: 1.1em;
        font-weight: bold;
        margin: 0 10px;
        min-width: 60px; /* Ensure space for MM:SS */
        display: inline-block;
      }
      /* Style for the controls div */
      .control-option {
        margin-top: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .control-option label {
        margin-right: 10px;
        font-weight: bold;
      }
      /* Specific style for the checkbox labels */
      #cry-controls label,
      #autocomplete-controls label {
        margin-left: 5px; /* Add space between checkbox and label */
        margin-right: 0; /* Reset right margin if not needed */
        font-weight: normal; /* Make checkbox label less bold */
      }
      #cry-controls,
      #autocomplete-controls {
        margin-top: 10px;
      }

      #start-game {
        margin-top: 15px;
        padding: 10px 20px;
        font-size: 1.1em;
        background-color: #28a745; /* Green */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #start-game:hover {
        background-color: #218838;
      }
      #restart-game {
        /* display: none; // Managed by #endgame-controls display property */
        background-color: #007bff; /* Blue */
        margin-left: 10px; /* Add space if both buttons appear */
        padding: 10px 20px;
        font-size: 1em;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #restart-game:hover {
        background-color: #0056b3;
      }

      #status-display {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        font-size: 1.1em;
        font-weight: bold;
      }
      #timer-area span,
      #score-area span {
        color: #007bff; /* Blue */
      }
      #score-area span.incorrect {
        color: #dc3545; /* Red */
      }

      #pokemon-display {
        margin-bottom: 20px;
        height: 200px; /* Fixed height for consistency */
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative; /* For loading overlay */
      }

      #pokemon-image {
        max-width: 100%;
        max-height: 200px;
        height: auto;
        display: block; /* Remove extra space below image */
        margin: 0 auto; /* Center image */
        opacity: 1;
        transition: opacity 0.3s ease-in-out; /* Smooth reveal */
      }

      #pokemon-image.silhouette {
        filter: brightness(0); /* Make the image black */
        opacity: 1;
      }
      #pokemon-image.hidden {
        opacity: 0;
      }

      #loading {
        position: absolute;
        font-size: 1.1em;
        color: #555;
      }

      #guess-area {
        position: relative; /* Needed for absolute positioning of autocomplete */
        margin-bottom: 10px;
      }

      #pokemon-guess {
        width: 90%;
        padding: 12px 15px;
        font-size: 1.1em;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box; /* Include padding in width */
      }
      #pokemon-guess:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
      }

      #autocomplete-list {
        list-style: none;
        padding: 0;
        margin: 0;
        position: absolute;
        left: 5%; /* Align with input */
        right: 5%; /* Align with input */
        top: 100%; /* Position below input */
        background-color: #fff;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 10;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none; /* Hidden by default */
      }

      #autocomplete-list li {
        padding: 10px 15px;
        cursor: pointer;
        text-align: left;
      }

      #autocomplete-list li:hover,
      #autocomplete-list li.autocomplete-highlight {
        background-color: #eee;
      }

      #feedback {
        margin-top: 10px;
        font-size: 1.2em;
        font-weight: bold;
        min-height: 1.5em; /* Prevent layout shifts */
        color: #555; /* Default feedback color */
      }

      #feedback.correct {
        color: #28a745; /* Green */
      }

      #feedback.incorrect {
        color: #dc3545; /* Red */
      }
      #feedback.info {
        color: #007bff; /* Blue for game end messages */
      }

      #next-pokemon {
        display: none; /* Hidden initially */
        margin-top: 15px;
        padding: 10px 20px;
        font-size: 1em;
        background-color: #ffc107; /* Yellow */
        color: #333;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      #next-pokemon:hover {
        background-color: #e0a800;
      }

      /* Controls shown after game ends */
      #endgame-controls {
        margin-top: 15px;
        display: none; /* Hidden initially */
      }
      #return-to-setup {
        padding: 10px 20px;
        font-size: 1em;
        background-color: #6c757d; /* Grey */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #return-to-setup:hover {
        background-color: #5a6268;
      }
    </style>
  </head>
  <body>
    <h1>Who's That Pokémon?</h1>

    <div id="controls-container">
      <h2>Game Setup</h2>
      <div id="timer-controls" class="control-option">
        <label for="timer-setting">Timer:</label>
        <button id="decrease-time" aria-label="Decrease time by 30 seconds">
          -
        </button>
        <span id="timer-setting">01:00</span>
        <button id="increase-time" aria-label="Increase time by 30 seconds">
          +
        </button>
      </div>
      <!-- Pokemon Cry Checkbox -->
      <div id="cry-controls" class="control-option">
        <input type="checkbox" id="play-cry-checkbox" name="play-cry" />
        <label for="play-cry-checkbox">Play Pokémon Cry</label>
      </div>
      <!-- Autocomplete Checkbox -->
      <div id="autocomplete-controls" class="control-option">
        <input
          type="checkbox"
          id="autocomplete-checkbox"
          name="autocomplete"
          checked
        />
        <!-- Default to checked -->
        <label for="autocomplete-checkbox">Enable Autocomplete</label>
      </div>
      <button id="start-game">Start Game</button>
    </div>

    <div id="game-container">
      <div id="status-display">
        <div id="timer-area">Time: <span id="time-left">00:00</span></div>
        <div id="score-area">
          Score: <span id="correct-count">0</span> /
          <span id="incorrect-count" class="incorrect">0</span>
        </div>
      </div>

      <div id="pokemon-display">
        <p id="loading">Loading Pokémon...</p>
        <img
          id="pokemon-image"
          src=""
          alt="Pokémon Silhouette"
          class="silhouette hidden"
        />
      </div>
      <div id="guess-area">
        <input
          type="text"
          id="pokemon-guess"
          placeholder="Enter Pokémon name..."
          autocomplete="off"
        />
        <ul id="autocomplete-list"></ul>
      </div>
      <div id="feedback">Guess the Pokémon!</div>
      <button id="next-pokemon">Next Pokémon</button>

      <!-- Controls shown after game end -->
      <div id="endgame-controls">
        <button id="restart-game">Restart Game</button>
        <button id="return-to-setup">Change Settings</button>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        const gen1PokemonNames = [
          "bulbasaur",
          "ivysaur",
          "venusaur",
          "charmander",
          "charmeleon",
          "charizard",
          "squirtle",
          "wartortle",
          "blastoise",
          "caterpie",
          "metapod",
          "butterfree",
          "weedle",
          "kakuna",
          "beedrill",
          "pidgey",
          "pidgeotto",
          "pidgeot",
          "rattata",
          "raticate",
          "spearow",
          "fearow",
          "ekans",
          "arbok",
          "pikachu",
          "raichu",
          "sandshrew",
          "sandslash",
          "nidoran-f",
          "nidorina",
          "nidoqueen",
          "nidoran-m",
          "nidorino",
          "nidoking",
          "clefairy",
          "clefable",
          "vulpix",
          "ninetales",
          "jigglypuff",
          "wigglytuff",
          "zubat",
          "golbat",
          "oddish",
          "gloom",
          "vileplume",
          "paras",
          "parasect",
          "venonat",
          "venomoth",
          "diglett",
          "dugtrio",
          "meowth",
          "persian",
          "psyduck",
          "golduck",
          "mankey",
          "primeape",
          "growlithe",
          "arcanine",
          "poliwag",
          "poliwhirl",
          "poliwrath",
          "abra",
          "kadabra",
          "alakazam",
          "machop",
          "machoke",
          "machamp",
          "bellsprout",
          "weepinbell",
          "victreebel",
          "tentacool",
          "tentacruel",
          "geodude",
          "graveler",
          "golem",
          "ponyta",
          "rapidash",
          "slowpoke",
          "slowbro",
          "magnemite",
          "magneton",
          "farfetchd",
          "doduo",
          "dodrio",
          "seel",
          "dewgong",
          "grimer",
          "muk",
          "shellder",
          "cloyster",
          "gastly",
          "haunter",
          "gengar",
          "onix",
          "drowzee",
          "hypno",
          "krabby",
          "kingler",
          "voltorb",
          "electrode",
          "exeggcute",
          "exeggutor",
          "cubone",
          "marowak",
          "hitmonlee",
          "hitmonchan",
          "lickitung",
          "koffing",
          "weezing",
          "rhyhorn",
          "rhydon",
          "chansey",
          "tangela",
          "kangaskhan",
          "horsea",
          "seadra",
          "goldeen",
          "seaking",
          "staryu",
          "starmie",
          "mr-mime",
          "scyther",
          "jynx",
          "electabuzz",
          "magmar",
          "pinsir",
          "tauros",
          "magikarp",
          "gyarados",
          "lapras",
          "ditto",
          "eevee",
          "vaporeon",
          "jolteon",
          "flareon",
          "porygon",
          "omanyte",
          "omastar",
          "kabuto",
          "kabutops",
          "aerodactyl",
          "snorlax",
          "articuno",
          "zapdos",
          "moltres",
          "dratini",
          "dragonair",
          "dragonite",
          "mewtwo",
          "mew",
        ];
        const TOTAL_POKEMON = gen1PokemonNames.length; // 151

        let currentPokemonName = "";
        let currentPokemonImageUrl = "";
        let currentPokemonCryUrl = "";
        let currentPokemonId = null;
        let guessedPokemonIds = new Set(); // Use a Set for efficient checking

        let correctCount = 0;
        let incorrectCount = 0;
        let firstIncorrectGuessMade = false; // Track first wrong guess per Pokemon

        let timerInterval = null;
        let timerDuration = 60; // Default 1 minute (in seconds)
        let timeLeft = 0;
        let playCryEnabled = false; // State for playing cries
        let autocompleteEnabled = true; // State for autocomplete suggestions

        let gameIsActive = false; // Overall game state
        let roundActive = false; // Controls guessing for the current Pokemon

        let highlightedAutocompleteIndex = -1;

        // --- Utility Functions ---
        function formatTime(seconds) {
          const minutes = Math.floor(seconds / 60);
          const remainingSeconds = seconds % 60;
          return `${minutes
            .toString()
            .padStart(2, "0")}:${remainingSeconds.toString().padStart(2, "0")}`;
        }

        function updateTimerDisplay() {
          $("#time-left").text(formatTime(timeLeft));
        }

        function updateScoreDisplay() {
          $("#correct-count").text(correctCount);
          $("#incorrect-count").text(incorrectCount);
        }

        function revealPokemon() {
          $("#pokemon-image").removeClass("silhouette hidden");
        }

        function normalizeName(name) {
          return name
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9-]+/g, "");
        }

        function displayPokemonName(name) {
          return (
            name.charAt(0).toUpperCase() +
            name
              .slice(1)
              .replace("-f", "♀")
              .replace("-m", "♂")
              .replace("-", " ")
          );
        }

        function playSound(url) {
          if (url) {
            try {
              const audio = new Audio(url);
              audio.volume = 0.3; // Set volume to 30%
              audio
                .play()
                .catch((e) => console.error("Error playing sound:", e)); // Handle autoplay restrictions/errors
            } catch (e) {
              console.error("Error creating audio element:", e);
            }
          }
        }

        // --- Timer Controls ---
        $("#increase-time").on("click", function () {
          if (!gameIsActive) {
            timerDuration += 30;
            $("#timer-setting").text(formatTime(timerDuration));
          }
        });

        $("#decrease-time").on("click", function () {
          if (!gameIsActive && timerDuration > 30) {
            timerDuration -= 30;
            $("#timer-setting").text(formatTime(timerDuration));
          }
        });

        // --- Game State Functions ---
        function initGame() {
          gameIsActive = false;
          roundActive = false;
          stopTimer();
          correctCount = 0;
          incorrectCount = 0;
          guessedPokemonIds.clear();
          highlightedAutocompleteIndex = -1;

          $("#controls-container").show();
          $("#game-container").hide();
          $("#endgame-controls").hide(); // Hide endgame buttons
          $("#timer-controls button").prop("disabled", false);
          $("#play-cry-checkbox").prop("disabled", false);
          $("#autocomplete-checkbox").prop("disabled", false); // Enable autocomplete checkbox

          // Reset checkboxes to defaults for a new setup
          $("#play-cry-checkbox").prop("checked", false);
          $("#autocomplete-checkbox").prop("checked", true); // Default autocomplete to on

          $("#timer-setting").text(formatTime(timerDuration)); // Reflect current timer setting
          updateScoreDisplay(); // Reset score display

          // Reset UI elements inside game container for next start
          $("#pokemon-guess").val("").prop("disabled", true);
          $("#feedback")
            .text("Guess the Pokémon!")
            .removeClass("correct incorrect info");
          $("#pokemon-image").addClass("silhouette hidden").attr("src", "");
          $("#loading").show().text("Loading Pokémon..."); // Reset loading text
          $("#autocomplete-list").hide().empty();
          $("#next-pokemon").hide();
        }

        function startGame() {
          gameIsActive = true;
          correctCount = 0;
          incorrectCount = 0;
          guessedPokemonIds.clear();
          updateScoreDisplay();

          // Read settings from controls
          playCryEnabled = $("#play-cry-checkbox").is(":checked");
          autocompleteEnabled = $("#autocomplete-checkbox").is(":checked"); // Read autocomplete setting

          $("#controls-container").hide();
          $("#game-container").show();
          $("#endgame-controls").hide(); // Ensure endgame buttons are hidden on start
          $("#timer-controls button").prop("disabled", true); // Disable timer adjust during game
          $("#play-cry-checkbox").prop("disabled", true); // Disable cry checkbox during game
          $("#autocomplete-checkbox").prop("disabled", true); // Disable autocomplete checkbox during game

          $("#feedback")
            .text("Guess the Pokémon!")
            .removeClass("correct incorrect info");

          timeLeft = timerDuration;
          updateTimerDisplay();
          startTimer();
          loadPokemon();
        }

        function endGame(reason) {
          gameIsActive = false;
          roundActive = false;
          stopTimer();

          $("#pokemon-guess").prop("disabled", true);
          $("#next-pokemon").hide();
          $("#autocomplete-list").hide();
          if (currentPokemonImageUrl) {
            // Only reveal if an image was loaded
            revealPokemon(); // Show the last Pokemon if time ran out or game ended
          }

          const finalMessageBase = `Final Score: ${correctCount} Correct, ${incorrectCount} Incorrect.`;
          let feedbackText = "";

          if (reason === "timeup") {
            feedbackText = `Time's Up! ${finalMessageBase}`;
          } else if (reason === "complete") {
            feedbackText = `Congratulations! You guessed all ${TOTAL_POKEMON} Pokémon! ${finalMessageBase}`;
          } else {
            feedbackText = `Game Over! ${finalMessageBase}`; // Generic end
          }

          $("#feedback")
            .text(feedbackText)
            .removeClass("correct incorrect")
            .addClass("info");

          // Show the endgame controls div, which contains both buttons
          $("#endgame-controls").show();
        }

        function startTimer() {
          if (timerInterval) clearInterval(timerInterval);
          timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
              endGame("timeup");
            }
          }, 1000);
        }

        function stopTimer() {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        // --- Pokémon Loading ---
        function loadPokemon() {
          if (!gameIsActive) return;

          if (guessedPokemonIds.size === TOTAL_POKEMON) {
            endGame("complete");
            return;
          }

          roundActive = false;
          firstIncorrectGuessMade = false;
          $("#pokemon-image").addClass("hidden");
          $("#loading").show().text("Loading Pokémon..."); // Reset loading text
          $("#feedback").text("").removeClass("correct incorrect info");
          $("#pokemon-guess").val("").prop("disabled", true);
          $("#autocomplete-list").hide().empty();
          $("#next-pokemon").hide();
          highlightedAutocompleteIndex = -1;
          currentPokemonCryUrl = ""; // Reset cry URL
          currentPokemonImageUrl = ""; // Reset image URL

          let randomId;
          do {
            randomId = Math.floor(Math.random() * TOTAL_POKEMON) + 1;
          } while (guessedPokemonIds.has(randomId));

          const apiUrl = `https://pokeapi.co/api/v2/pokemon/${randomId}`;

          $.getJSON(apiUrl, function (data) {
            if (!gameIsActive) return;

            currentPokemonName = data.name;
            currentPokemonId = data.id;
            currentPokemonImageUrl =
              data.sprites.other["official-artwork"].front_default ||
              data.sprites.front_default; // Fallback included
            currentPokemonCryUrl =
              data.cries?.latest || data.cries?.legacy || ""; // Get cry URL, prefer latest

            // Preload image
            $("<img>")
              .attr("src", currentPokemonImageUrl)
              .on("load", function () {
                if (gameIsActive && currentPokemonId === data.id) {
                  // Check if still relevant
                  $(this).remove(); // Remove the preloader image element
                  $("#pokemon-image")
                    .attr("src", currentPokemonImageUrl)
                    .removeClass("hidden")
                    .addClass("silhouette");

                  $("#loading").hide();
                  $("#pokemon-guess").prop("disabled", false).focus();
                  $("#feedback").text("Guess the Pokémon!");
                  guessedPokemonIds.add(currentPokemonId);
                  roundActive = true;

                  // Play cry if enabled AFTER silhouette is shown
                  if (playCryEnabled) {
                    playSound(currentPokemonCryUrl);
                  }
                }
              })
              .on("error", function () {
                $(this).remove(); // Remove preloader on error too
                if (gameIsActive) {
                  console.error(
                    `Error loading image for Pokemon ID ${currentPokemonId}: ${currentPokemonImageUrl}`
                  );
                  $("#loading").text("Image error. Loading another...");
                  setTimeout(loadPokemon, 1500); // Try loading a different Pokemon
                }
              });
          }).fail(function (jqXHR, textStatus, errorThrown) {
            if (gameIsActive) {
              console.error("PokeAPI fetch failed:", textStatus, errorThrown);
              $("#loading").text("Error loading Pokémon data. Retrying...");
              setTimeout(loadPokemon, 3000); // Retry loading
            }
          });
        }

        // --- Autocomplete Logic ---
        $("#pokemon-guess").on("input", function () {
          if (!roundActive || !autocompleteEnabled) {
            // Check if autocomplete is enabled
            $("#autocomplete-list").empty().hide(); // Ensure list is hidden if disabled
            return;
          }

          const inputText = normalizeName($(this).val());
          const $autocompleteList = $("#autocomplete-list");
          $autocompleteList.empty().hide();
          highlightedAutocompleteIndex = -1;

          if (inputText.length === 0) {
            return;
          }

          const matches = gen1PokemonNames.filter((name) =>
            name.startsWith(inputText)
          );

          if (matches.length > 0) {
            matches.forEach((name, index) => {
              const displayName = displayPokemonName(name);
              const $li = $("<li></li>")
                .text(displayName)
                .attr("data-value", name)
                .data("index", index);
              $autocompleteList.append($li);
            });
            $autocompleteList.show();
          }
        });

        // Autocomplete Keyboard Navigation
        $("#pokemon-guess").on("keydown", function (event) {
          if (!roundActive) return;

          const $list = $("#autocomplete-list");
          const listIsVisible = $list.is(":visible") && autocompleteEnabled; // Check if enabled AND visible

          // Handle Enter key always for submission
          if (event.key === "Enter") {
            event.preventDefault();
            if (listIsVisible && highlightedAutocompleteIndex !== -1) {
              $list
                .find("li")
                .eq(highlightedAutocompleteIndex)
                .trigger("click"); // Trigger click to select and check
            } else {
              checkGuess(); // Check current input if no item is highlighted or list not visible/enabled
            }
            $list.hide(); // Hide list after Enter press
            return; // Prevent further processing for Enter
          }

          // Handle Escape key always to hide list
          if (event.key === "Escape") {
            if (listIsVisible) {
              event.preventDefault();
              $list.hide();
              highlightedAutocompleteIndex = -1;
            }
            return; // Prevent further processing for Escape
          }

          // Only handle Arrow/Tab navigation if the list should be visible and navigable
          if (!listIsVisible) {
            return;
          }

          const $items = $list.find("li");
          const itemsCount = $items.length;
          if (itemsCount === 0) return; // No items to navigate

          switch (event.key) {
            case "ArrowDown":
            case "Tab": // Allow Tab to cycle down
              event.preventDefault();
              if (highlightedAutocompleteIndex < itemsCount - 1) {
                highlightedAutocompleteIndex++;
              } else {
                highlightedAutocompleteIndex = 0; // Wrap around
              }
              highlightAutocompleteItem($items);
              break;

            case "ArrowUp":
              event.preventDefault();
              if (highlightedAutocompleteIndex > 0) {
                highlightedAutocompleteIndex--;
              } else {
                highlightedAutocompleteIndex = itemsCount - 1; // Wrap around
              }
              highlightAutocompleteItem($items);
              break;
          }
        });

        function highlightAutocompleteItem($items) {
          // This function only relevant if autocomplete is enabled, but check index anyway
          $items.removeClass("autocomplete-highlight");
          if (highlightedAutocompleteIndex !== -1) {
            const $currentItem = $items.eq(highlightedAutocompleteIndex);
            $currentItem.addClass("autocomplete-highlight");

            // Scroll into view logic
            const listElement = $("#autocomplete-list")[0];
            const itemElement = $currentItem[0];
            // Check if itemElement exists before accessing properties
            if (itemElement && listElement) {
              // Basic scroll into view if needed
              if (
                itemElement.offsetTop < listElement.scrollTop ||
                itemElement.offsetTop + itemElement.offsetHeight >
                  listElement.scrollTop + listElement.clientHeight
              ) {
                itemElement.scrollIntoView({
                  block: "nearest",
                  behavior: "smooth",
                });
              }
            }
          }
        }

        // --- Select Autocomplete Suggestion (Click) ---
        $("#autocomplete-list").on("click", "li", function () {
          // This event only triggers if list is visible (autocomplete enabled)
          if (!roundActive) return;
          const selectedName = $(this).attr("data-value");
          $("#pokemon-guess").val(displayPokemonName(selectedName)); // Show formatted name
          $("#autocomplete-list").hide().empty();
          highlightedAutocompleteIndex = -1;
          checkGuess(selectedName); // Check guess immediately with the correct normalized name
          $("#pokemon-guess").focus(); // Keep focus on input for potential corrections? Or maybe not needed after click.
        });

        // --- Hide Autocomplete on Click Outside ---
        $(document).on("click", function (event) {
          // Only hide if autocomplete is enabled and the list is potentially visible
          if (
            autocompleteEnabled &&
            !$(event.target).closest("#pokemon-guess, #autocomplete-list")
              .length
          ) {
            $("#autocomplete-list").hide();
            highlightedAutocompleteIndex = -1;
          }
        });

        // --- Check Guess Function ---
        function checkGuess(directGuess = null) {
          if (!roundActive || !gameIsActive) return;

          const userGuess = normalizeName(
            directGuess ? directGuess : $("#pokemon-guess").val()
          );
          const $feedback = $("#feedback");
          $("#autocomplete-list").hide(); // Hide list after any guess attempt

          if (!userGuess) {
            $feedback
              .text("Please enter a Pokémon name.")
              .removeClass("correct incorrect")
              .addClass("info");
            return; // Ignore empty guess but provide feedback
          }

          if (userGuess === currentPokemonName) {
            correctCount++;
            updateScoreDisplay();
            $feedback
              .text(`Correct! It's ${displayPokemonName(currentPokemonName)}!`)
              .removeClass("incorrect info")
              .addClass("correct");
            revealPokemon();
            $("#pokemon-guess").prop("disabled", true);
            $("#next-pokemon").show().focus(); // Focus next button
            roundActive = false;
          } else {
            if (!firstIncorrectGuessMade) {
              incorrectCount++;
              firstIncorrectGuessMade = true;
              updateScoreDisplay();
            }
            $feedback
              .text("Incorrect! Try again.")
              .removeClass("correct info")
              .addClass("incorrect");
            $("#pokemon-guess").select(); // Select text to easily type over
          }
        }

        // --- Handle "Next Pokémon" Button Click ---
        $("#next-pokemon").on("click", function () {
          if (gameIsActive) {
            loadPokemon();
          }
        });

        // --- Handle Start/Restart/Setup Button Clicks ---
        $("#start-game").on("click", startGame);

        // Button shown after game ends: Restart with same settings
        $("#restart-game").on("click", startGame); // Calls startGame to immediately restart

        // Button shown after game ends: Go back to setup screen
        $("#return-to-setup").on("click", initGame); // Calls initGame to show setup screen

        // --- Initial Setup ---
        initGame(); // Set up the initial screen
      });
    </script>
  </body>
</html>
