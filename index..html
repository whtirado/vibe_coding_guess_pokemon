<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Title updated to reflect multiple generations -->
    <title>Who's That Pokémon? (All Gens)</title>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        text-shadow: 1px 1px 2px #aaa;
      }

      #controls-container,
      #game-container {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 450px; /* Increased width slightly */
        width: 100%;
        margin-bottom: 15px;
      }

      #game-container {
        display: none; /* Initially hidden */
      }

      #timer-controls button {
        padding: 5px 10px;
        font-size: 1.2em;
        margin: 0 5px;
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #eee;
        border-radius: 4px;
      }
      #timer-controls span {
        font-size: 1.1em;
        font-weight: bold;
        margin: 0 10px;
        min-width: 60px;
        display: inline-block;
      }

      .control-option {
        margin-top: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap; /* Allow wrapping for generation checkboxes */
      }
      .control-option label {
        margin-right: 10px;
        font-weight: bold;
      }
      /* Checkbox labels */
      #cry-controls label,
      #autocomplete-controls label,
      #dex-number-controls label,
      #generation-controls label {
        margin-left: 5px;
        margin-right: 0;
        font-weight: normal;
      }
      #cry-controls,
      #autocomplete-controls,
      #dex-number-controls,
      #generation-controls {
        margin-top: 10px;
      }

      /* Generation Selection Styles */
      #generation-selector {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 5px;
        max-width: 350px; /* Limit width of checkbox area */
        margin-left: auto;
        margin-right: auto;
      }
      .gen-checkbox-label {
        display: inline-flex; /* Use inline-flex for better alignment */
        align-items: center;
        margin-right: 10px; /* Spacing between checkboxes */
        font-weight: normal;
        cursor: pointer;
      }
      .gen-checkbox-label input[type="checkbox"] {
        margin-right: 4px; /* Space between checkbox and its text */
      }

      #start-game {
        margin-top: 20px; /* Increased margin */
        padding: 10px 20px;
        font-size: 1.1em;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #start-game:hover:not(:disabled) {
        background-color: #218838;
      }
      #start-game:disabled {
        background-color: #aaa;
        cursor: not-allowed;
      }
      #loading-names {
        font-style: italic;
        color: #555;
        margin-top: 10px;
        display: none; /* Hidden initially */
      }

      #restart-game {
        background-color: #007bff;
        margin-left: 10px;
        padding: 10px 20px;
        font-size: 1em;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #restart-game:hover {
        background-color: #0056b3;
      }

      #status-display {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        font-size: 1.1em;
        font-weight: bold;
      }
      #timer-area span,
      #score-area span {
        color: #007bff;
      }
      #score-area span.incorrect {
        color: #dc3545;
      }

      #pokemon-display {
        margin-bottom: 20px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      #pokemon-image {
        max-width: 100%;
        max-height: 200px;
        height: auto;
        display: block;
        margin: 0 auto;
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
      }
      #pokemon-image.silhouette {
        filter: brightness(0);
        opacity: 1;
      }
      #pokemon-image.hidden {
        opacity: 0;
      }

      #loading {
        position: absolute;
        font-size: 1.1em;
        color: #555;
      }

      #guess-area {
        position: relative;
        margin-bottom: 10px;
      }

      #pokemon-guess {
        width: 90%;
        padding: 12px 15px;
        font-size: 1.1em;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }
      #pokemon-guess:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
      }

      #autocomplete-list {
        list-style: none;
        padding: 0;
        margin: 0;
        position: absolute;
        left: 5%;
        right: 5%;
        top: 100%;
        background-color: #fff;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 10;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
      }
      #autocomplete-list li {
        padding: 10px 15px;
        cursor: pointer;
        text-align: left;
      }
      #autocomplete-list li:hover,
      #autocomplete-list li.autocomplete-highlight {
        background-color: #eee;
      }

      #feedback {
        margin-top: 10px;
        font-size: 1.2em;
        font-weight: bold;
        min-height: 1.5em;
        color: #555;
      }
      #feedback.correct {
        color: #28a745;
      }
      #feedback.incorrect {
        color: #dc3545;
      }
      #feedback.info {
        color: #007bff;
      }
      #feedback .dex-number {
        font-weight: normal;
        color: #555; /* Slightly muted color for dex number */
        font-size: 0.9em;
        margin-left: 5px;
      }

      #game-actions {
        margin-top: 15px;
        display: flex;
        justify-content: center;
        gap: 10px; /* Add space between buttons */
      }

      #skip-pokemon,
      #next-pokemon {
        padding: 10px 20px;
        font-size: 1em;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      #skip-pokemon {
        background-color: #ffc107; /* Yellow */
        color: #333;
        display: none; /* Hidden until round starts */
      }
      #skip-pokemon:hover {
        background-color: #e0a800;
      }
      #skip-pokemon:disabled {
        background-color: #aaa;
        cursor: not-allowed;
      }

      #next-pokemon {
        background-color: #17a2b8; /* Teal/Info */
        color: white;
        display: none; /* Hidden initially */
      }
      #next-pokemon:hover {
        background-color: #138496;
      }

      #endgame-controls {
        margin-top: 15px;
        display: none; /* Hidden initially */
      }
      #return-to-setup {
        padding: 10px 20px;
        font-size: 1em;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #return-to-setup:hover {
        background-color: #5a6268;
      }
    </style>
  </head>
  <body>
    <h1>Who's That Pokémon?</h1>

    <div id="controls-container">
      <h2>Game Setup</h2>
      <div id="timer-controls" class="control-option">
        <label for="timer-setting">Timer:</label>
        <button id="decrease-time" aria-label="Decrease time by 30 seconds">
          -
        </button>
        <span id="timer-setting">01:00</span>
        <button id="increase-time" aria-label="Increase time by 30 seconds">
          +
        </button>
      </div>

      <!-- Generation Selection -->
      <div id="generation-controls" class="control-option">
        <label>Generations:</label>
        <div id="generation-selector">
          <!-- Checkboxes will be populated by JS -->
        </div>
      </div>

      <!-- Pokemon Cry Checkbox -->
      <div id="cry-controls" class="control-option">
        <input type="checkbox" id="play-cry-checkbox" name="play-cry" />
        <label for="play-cry-checkbox">Play Pokémon Cry</label>
      </div>

      <!-- Autocomplete Checkbox -->
      <div id="autocomplete-controls" class="control-option">
        <input
          type="checkbox"
          id="autocomplete-checkbox"
          name="autocomplete"
          checked
        />
        <label for="autocomplete-checkbox">Enable Autocomplete</label>
      </div>

      <!-- Show Dex Number Checkbox -->
      <div id="dex-number-controls" class="control-option">
        <input
          type="checkbox"
          id="show-dex-number-checkbox"
          name="show-dex-number"
        />
        <label for="show-dex-number-checkbox">Show National Dex Number</label>
      </div>

      <button id="start-game" disabled>Loading Pokémon Data...</button>
      <p id="loading-names">Fetching Pokémon list...</p>
    </div>

    <div id="game-container">
      <div id="status-display">
        <div id="timer-area">Time: <span id="time-left">00:00</span></div>
        <div id="score-area">
          Score: <span id="correct-count">0</span> /
          <span id="incorrect-count" class="incorrect">0</span>
        </div>
      </div>

      <div id="pokemon-display">
        <p id="loading">Loading Pokémon...</p>
        <img
          id="pokemon-image"
          src=""
          alt="Pokémon Silhouette"
          class="silhouette hidden"
        />
      </div>
      <div id="guess-area">
        <input
          type="text"
          id="pokemon-guess"
          placeholder="Enter Pokémon name..."
          autocomplete="off"
        />
        <ul id="autocomplete-list"></ul>
      </div>
      <div id="feedback">Guess the Pokémon!</div>

      <!-- Action Buttons Container -->
      <div id="game-actions">
        <button id="skip-pokemon">Skip</button>
        <button id="next-pokemon">Next Pokémon</button>
      </div>

      <!-- Controls shown after game end -->
      <div id="endgame-controls">
        <button id="restart-game">Restart Game</button>
        <button id="return-to-setup">Change Settings</button>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        // Define Generation Ranges (inclusive) - Updated for Gen 9 DLC
        const generationRanges = {
          1: { start: 1, end: 151, name: "Gen 1" },
          2: { start: 152, end: 251, name: "Gen 2" },
          3: { start: 252, end: 386, name: "Gen 3" },
          4: { start: 387, end: 493, name: "Gen 4" },
          5: { start: 494, end: 649, name: "Gen 5" },
          6: { start: 650, end: 721, name: "Gen 6" },
          7: { start: 722, end: 809, name: "Gen 7" },
          8: { start: 810, end: 905, name: "Gen 8" }, // Includes Hisui
          9: { start: 906, end: 1025, name: "Gen 9" }, // Includes Paldea + Kitakami + Blueberry
        };
        const LATEST_POKEMON_ID = 1025; // Current max National Dex number

        // Global Pokemon Data Store
        let allPokemonData = []; // Will store { name: string, id: number } for all fetched Pokemon

        // Game State Variables
        let availablePokemonIds = []; // IDs for the current game based on selected generations
        let selectedPokemonNames = []; // Names corresponding to availablePokemonIds for autocomplete
        let totalSelectedPokemon = 0; // Count of Pokemon in selected generations

        let currentPokemonName = "";
        let currentPokemonImageUrl = "";
        let currentPokemonCryUrl = "";
        let currentPokemonId = null;
        let guessedPokemonIds = new Set();

        let correctCount = 0;
        let incorrectCount = 0;
        let firstIncorrectGuessMade = false;

        let timerInterval = null;
        let timerDuration = 60;
        let timeLeft = 0;

        // Game Settings
        let playCryEnabled = false;
        let autocompleteEnabled = true;
        let showDexNumberEnabled = false; // Default off for Dex Number

        let gameIsActive = false;
        let roundActive = false;

        let highlightedAutocompleteIndex = -1;

        // --- Utility Functions ---
        function formatTime(seconds) {
          const minutes = Math.floor(seconds / 60);
          const remainingSeconds = seconds % 60;
          return `${minutes
            .toString()
            .padStart(2, "0")}:${remainingSeconds.toString().padStart(2, "0")}`;
        }

        function updateTimerDisplay() {
          $("#time-left").text(formatTime(timeLeft));
        }

        function updateScoreDisplay() {
          $("#correct-count").text(correctCount);
          $("#incorrect-count").text(incorrectCount);
        }

        function revealPokemon(showFeedback = true) {
          $("#pokemon-image").removeClass("silhouette hidden");
          if (showFeedback) {
            // Add dex number to feedback if enabled
            const dexNumText = showDexNumberEnabled
              ? ` (#${currentPokemonId})`
              : "";
            $("#feedback").html(
              `${displayPokemonName(
                currentPokemonName
              )}<span class="dex-number">${dexNumText}</span>`
            ); // Use .html() to render span
          }
        }

        function normalizeName(name) {
          // Handles most cases including Nidoran♀/♂, forms like meowth-galar, etc.
          // It also handles names with spaces like 'Mr. Mime' becoming 'mr-mime' from PokeAPI
          return name
            .toLowerCase()
            .trim()
            .replace(/\s+/g, "-") // Replace spaces with hyphens
            .replace(/[^a-z0-9-]+/g, "") // Remove invalid characters (like periods, apostrophes)
            .replace(/[\u2640\u2642]/g, ""); // Remove female/male symbols if present in input
        }

        function displayPokemonName(name) {
          // Capitalize, handle hyphens, and specific cases like Nidoran/Mr. Mime
          if (!name) return "";
          let displayName = name
            .replace(/-/g, " ") // Replace hyphens with spaces for display
            .replace(" f", "♀") // Handle nidoran-f specifically
            .replace(" m", "♂"); // Handle nidoran-m specifically

          // Capitalize each part of the name (e.g., "Mr Mime", "Ho Oh")
          displayName = displayName
            .split(" ")
            .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
            .join(" ");

          // Handle specific overrides if needed (e.g., Farfetch'd)
          if (name === "farfetchd") displayName = "Farfetch'd";
          if (name === "mr-mime") displayName = "Mr. Mime";
          if (name === "mime-jr") displayName = "Mime Jr.";
          if (name === "type-null") displayName = "Type: Null";
          if (
            name === "tapu-koko" ||
            name === "tapu-lele" ||
            name === "tapu-bulu" ||
            name === "tapu-fini"
          )
            displayName = displayName.replace("Tapu ", "Tapu "); // Ensure space after Tapu

          return displayName;
        }

        function playSound(url) {
          if (url) {
            try {
              const audio = new Audio(url);
              audio.volume = 0.3;
              audio
                .play()
                .catch((e) => console.error("Error playing sound:", e));
            } catch (e) {
              console.error("Error creating audio element:", e);
            }
          }
        }

        // --- Fetch All Pokemon Names on Load ---
        function fetchAllPokemonNames() {
          $("#loading-names").show();
          $("#start-game")
            .text("Loading Pokémon Data...")
            .prop("disabled", true);
          $.getJSON(
            `https://pokeapi.co/api/v2/pokemon?limit=${LATEST_POKEMON_ID}&offset=0`,
            function (data) {
              allPokemonData = data.results.map((p) => {
                const urlParts = p.url.split("/");
                const id = parseInt(urlParts[urlParts.length - 2]);
                return { name: p.name, id: id };
              });
              // Filter out potential null/invalid entries if any - ensure ID is within known range
              allPokemonData = allPokemonData.filter(
                (p) => p.id > 0 && p.id <= LATEST_POKEMON_ID
              );
              console.log(`Fetched ${allPokemonData.length} Pokémon names.`);
              $("#start-game").text("Start Game").prop("disabled", false);
              $("#loading-names").hide();
            }
          ).fail(function (jqXHR, textStatus, errorThrown) {
            console.error(
              "Failed to fetch Pokémon list:",
              textStatus,
              errorThrown
            );
            $("#loading-names")
              .text("Error loading Pokémon list. Please refresh.")
              .show();
            $("#start-game").text("Error").prop("disabled", true);
          });
        }

        // --- Populate Generation Checkboxes ---
        function populateGenerationCheckboxes() {
          const $selector = $("#generation-selector");
          $selector.empty(); // Clear previous checkboxes if any
          Object.keys(generationRanges).forEach((genKey) => {
            const genInfo = generationRanges[genKey];
            const checkboxId = `gen-${genKey}-checkbox`;
            // Check Gen 1 by default
            const isChecked = genKey === "1";
            $selector.append(`
                    <label for="${checkboxId}" class="gen-checkbox-label">
                        <input type="checkbox" id="${checkboxId}" name="generation" value="${genKey}" ${
              isChecked ? "checked" : ""
            }>
                        ${genInfo.name}
                    </label>
                `);
          });
        }

        // --- Timer Controls ---
        $("#increase-time").on("click", function () {
          if (!gameIsActive) {
            timerDuration += 30;
            $("#timer-setting").text(formatTime(timerDuration));
          }
        });

        $("#decrease-time").on("click", function () {
          if (!gameIsActive && timerDuration > 30) {
            timerDuration -= 30;
            $("#timer-setting").text(formatTime(timerDuration));
          }
        });

        // --- Game State Functions ---
        function initGame() {
          gameIsActive = false;
          roundActive = false;
          stopTimer();
          correctCount = 0;
          incorrectCount = 0;
          guessedPokemonIds.clear();
          highlightedAutocompleteIndex = -1;
          availablePokemonIds = [];
          selectedPokemonNames = [];
          totalSelectedPokemon = 0;

          $("#controls-container").show();
          $("#game-container").hide();
          $("#endgame-controls").hide();
          $("#timer-controls button").prop("disabled", false);
          $("#play-cry-checkbox").prop("disabled", false);
          $("#autocomplete-checkbox").prop("disabled", false);
          $("#show-dex-number-checkbox").prop("disabled", false);
          $("#generation-selector input").prop("disabled", false);

          // Reset checkboxes to defaults (Gen 1 checked, others not, settings reset)
          populateGenerationCheckboxes(); // Repopulate to reset checks
          $("#play-cry-checkbox").prop("checked", false);
          $("#autocomplete-checkbox").prop("checked", true);
          $("#show-dex-number-checkbox").prop("checked", false);

          $("#timer-setting").text(formatTime(timerDuration));
          updateScoreDisplay();

          $("#pokemon-guess").val("").prop("disabled", true);
          $("#feedback")
            .text("Guess the Pokémon!")
            .removeClass("correct incorrect info");
          $("#pokemon-image").addClass("silhouette hidden").attr("src", "");
          $("#loading").show().text("Loading Pokémon...");
          $("#autocomplete-list").hide().empty();
          $("#next-pokemon").hide();
          $("#skip-pokemon").hide().prop("disabled", false); // Also hide skip button

          // Ensure start button is enabled if names are loaded
          if (allPokemonData.length > 0) {
            $("#start-game").text("Start Game").prop("disabled", false);
          } else {
            $("#start-game")
              .text("Loading Pokémon Data...")
              .prop("disabled", true);
          }
        }

        function startGame() {
          // --- Determine Selected Generations and Filter Pokemon ---
          availablePokemonIds = [];
          selectedPokemonNames = [];
          const selectedGenerations = $("#generation-selector input:checked")
            .map(function () {
              return parseInt($(this).val());
            })
            .get();

          if (selectedGenerations.length === 0) {
            alert("Please select at least one generation!");
            return; // Stop if no generations are selected
          }

          selectedGenerations.forEach((genKey) => {
            const range = generationRanges[genKey];
            const genPokemon = allPokemonData.filter(
              (p) => p.id >= range.start && p.id <= range.end
            );
            genPokemon.forEach((p) => {
              if (!availablePokemonIds.includes(p.id)) {
                // Avoid duplicates if ranges overlap (shouldn't happen here)
                availablePokemonIds.push(p.id);
                selectedPokemonNames.push(p.name); // Store names for autocomplete
              }
            });
          });

          if (availablePokemonIds.length === 0) {
            alert(
              "No Pokémon found for the selected generations. This shouldn't happen."
            );
            return;
          }

          totalSelectedPokemon = availablePokemonIds.length;
          console.log(
            `Starting game with ${totalSelectedPokemon} Pokémon from generations: ${selectedGenerations.join(
              ", "
            )}`
          );

          // --- Reset Game State ---
          gameIsActive = true;
          correctCount = 0;
          incorrectCount = 0;
          guessedPokemonIds.clear();
          updateScoreDisplay();

          // --- Read Settings ---
          playCryEnabled = $("#play-cry-checkbox").is(":checked");
          autocompleteEnabled = $("#autocomplete-checkbox").is(":checked");
          showDexNumberEnabled = $("#show-dex-number-checkbox").is(":checked");

          // --- Update UI ---
          $("#controls-container").hide();
          $("#game-container").show();
          $("#endgame-controls").hide();
          $("#timer-controls button").prop("disabled", true);
          $("#play-cry-checkbox").prop("disabled", true);
          $("#autocomplete-checkbox").prop("disabled", true);
          $("#show-dex-number-checkbox").prop("disabled", true);
          $("#generation-selector input").prop("disabled", true);

          $("#feedback")
            .text("Guess the Pokémon!")
            .removeClass("correct incorrect info");
          $("#skip-pokemon").hide(); // Hide skip initially

          timeLeft = timerDuration;
          updateTimerDisplay();
          startTimer();
          loadPokemon();
        }

        function endGame(reason) {
          gameIsActive = false;
          roundActive = false;
          stopTimer();

          $("#pokemon-guess").prop("disabled", true);
          $("#next-pokemon").hide();
          $("#skip-pokemon").hide().prop("disabled", true); // Hide and disable skip on game end
          $("#autocomplete-list").hide();
          if (currentPokemonImageUrl && currentPokemonName) {
            // Ensure we have a Pokemon loaded
            revealPokemon(); // Show the last Pokemon
          }

          const finalMessageBase = `Final Score: ${correctCount} Correct, ${incorrectCount} Incorrect out of ${totalSelectedPokemon} selected Pokémon.`;
          let feedbackText = "";

          if (reason === "timeup") {
            feedbackText = `Time's Up! ${finalMessageBase}`;
          } else if (reason === "complete") {
            feedbackText = `Congratulations! You guessed all ${totalSelectedPokemon} selected Pokémon! ${finalMessageBase}`;
          } else {
            feedbackText = `Game Over! ${finalMessageBase}`;
          }

          $("#feedback")
            .html(feedbackText)
            .removeClass("correct incorrect")
            .addClass("info"); // Use html() for potential future formatting
          $("#endgame-controls").show();
        }

        function startTimer() {
          if (timerInterval) clearInterval(timerInterval);
          timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
              endGame("timeup");
            }
          }, 1000);
        }

        function stopTimer() {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        // --- Pokémon Loading ---
        function loadPokemon() {
          if (!gameIsActive) return;

          // Check if all selected Pokemon have been guessed
          if (guessedPokemonIds.size === totalSelectedPokemon) {
            endGame("complete");
            return;
          }

          roundActive = false;
          firstIncorrectGuessMade = false;
          $("#pokemon-image").addClass("hidden silhouette"); // Ensure silhouette is added initially
          $("#loading").show().text("Loading Pokémon...");
          $("#feedback").text("").removeClass("correct incorrect info");
          $("#pokemon-guess").val("").prop("disabled", true);
          $("#autocomplete-list").hide().empty();
          $("#next-pokemon").hide();
          $("#skip-pokemon").hide().prop("disabled", true); // Hide skip until loaded
          highlightedAutocompleteIndex = -1;
          currentPokemonName = ""; // Reset current Pokemon data
          currentPokemonId = null;
          currentPokemonImageUrl = "";
          currentPokemonCryUrl = "";

          let randomId;
          let attempts = 0; // Prevent infinite loops in rare cases
          const maxAttempts = availablePokemonIds.length * 2; // Safety limit

          // Find an ID from the available list that hasn't been guessed yet
          do {
            const randomIndex = Math.floor(
              Math.random() * availablePokemonIds.length
            );
            randomId = availablePokemonIds[randomIndex];
            attempts++;
          } while (guessedPokemonIds.has(randomId) && attempts < maxAttempts);

          if (guessedPokemonIds.has(randomId) && attempts >= maxAttempts) {
            console.error(
              "Failed to find an unguessed Pokemon ID. Ending game."
            );
            // Attempt to find *any* unguessed ID as a last resort
            const unguessed = availablePokemonIds.find(
              (id) => !guessedPokemonIds.has(id)
            );
            if (unguessed) {
              randomId = unguessed;
            } else {
              endGame("complete"); // Or some error state
              return;
            }
          }

          const apiUrl = `https://pokeapi.co/api/v2/pokemon/${randomId}`;

          $.getJSON(apiUrl, function (data) {
            if (!gameIsActive) return; // Check if game ended while fetching

            currentPokemonName = data.name;
            currentPokemonId = data.id;
            // Prefer official artwork, fallback to front_default sprite
            currentPokemonImageUrl =
              data.sprites.other?.["official-artwork"]?.front_default ||
              data.sprites.front_default;
            currentPokemonCryUrl =
              data.cries?.latest || data.cries?.legacy || "";

            // Simple check if the image URL looks valid (basic)
            if (
              !currentPokemonImageUrl ||
              typeof currentPokemonImageUrl !== "string"
            ) {
              console.warn(
                `Missing or invalid image URL for ${currentPokemonName} (ID: ${currentPokemonId}). Using fallback.`
              );
              currentPokemonImageUrl = data.sprites.front_default; // Use default sprite if official is bad
              if (!currentPokemonImageUrl) {
                console.error(
                  `No valid image found for ${currentPokemonName}. Skipping.`
                );
                $("#loading").text("Image error. Loading another...");
                setTimeout(loadPokemon, 1500); // Try loading a different Pokemon
                return;
              }
            }

            // Preload image
            $("<img>")
              .attr("src", currentPokemonImageUrl)
              .on("load", function () {
                // Double-check if the game is still active and this is the intended pokemon
                if (gameIsActive && currentPokemonId === data.id) {
                  $(this).remove();
                  $("#pokemon-image")
                    .attr("src", currentPokemonImageUrl)
                    .removeClass("hidden") // Show silhouette
                    .addClass("silhouette");

                  $("#loading").hide();
                  $("#pokemon-guess").prop("disabled", false).focus();
                  $("#feedback").text("Guess the Pokémon!");
                  guessedPokemonIds.add(currentPokemonId); // Add to guessed *after* successful load
                  roundActive = true;
                  $("#skip-pokemon").show().prop("disabled", false); // Show and enable skip button

                  if (playCryEnabled) {
                    playSound(currentPokemonCryUrl);
                  }
                } else {
                  $(this).remove(); // Clean up if game state changed during load
                }
              })
              .on("error", function () {
                $(this).remove();
                if (gameIsActive) {
                  // Only retry if game is still running
                  console.error(
                    `Error loading image for ${currentPokemonName} (ID: ${currentPokemonId}): ${currentPokemonImageUrl}`
                  );
                  $("#loading").text("Image error. Loading another...");
                  // Don't add to guessedIds here, as it failed to load
                  setTimeout(loadPokemon, 1500); // Try loading a different Pokemon
                }
              });
          }).fail(function (jqXHR, textStatus, errorThrown) {
            if (gameIsActive) {
              console.error(
                "PokeAPI fetch failed:",
                textStatus,
                errorThrown,
                `for ID: ${randomId}`
              );
              $("#loading").text("Error loading Pokémon data. Retrying...");
              setTimeout(loadPokemon, 3000); // Retry loading
            }
          });
        }

        // --- Autocomplete Logic ---
        $("#pokemon-guess").on("input", function () {
          if (!roundActive || !autocompleteEnabled) {
            $("#autocomplete-list").empty().hide();
            return;
          }

          const inputText = normalizeName($(this).val()); // Use normalizeName for input matching
          const $autocompleteList = $("#autocomplete-list");
          $autocompleteList.empty().hide();
          highlightedAutocompleteIndex = -1;

          if (inputText.length === 0) {
            return;
          }

          // Filter selectedPokemonNames (which contains the normalized names for the current game)
          const matches = selectedPokemonNames.filter((name) =>
            name.startsWith(inputText)
          );

          if (matches.length > 0) {
            // Limit number of suggestions shown? e.g., top 10
            matches.slice(0, 10).forEach((name, index) => {
              const displayName = displayPokemonName(name); // Use display function for showing
              const $li = $("<li></li>")
                .text(displayName)
                .attr("data-value", name) // Store the normalized name
                .data("index", index);
              $autocompleteList.append($li);
            });
            $autocompleteList.show();
          }
        });

        // Autocomplete Keyboard Navigation
        $("#pokemon-guess").on("keydown", function (event) {
          if (!roundActive) return;

          const $list = $("#autocomplete-list");
          const listIsVisible = $list.is(":visible") && autocompleteEnabled;

          if (event.key === "Enter") {
            event.preventDefault();
            if (listIsVisible && highlightedAutocompleteIndex !== -1) {
              $list
                .find("li")
                .eq(highlightedAutocompleteIndex)
                .trigger("click");
            } else {
              checkGuess();
            }
            $list.hide();
            return;
          }

          if (event.key === "Escape") {
            if (listIsVisible) {
              event.preventDefault();
              $list.hide();
              highlightedAutocompleteIndex = -1;
            }
            return;
          }

          if (!listIsVisible) return;

          const $items = $list.find("li");
          const itemsCount = $items.length;
          if (itemsCount === 0) return;

          switch (event.key) {
            case "ArrowDown":
            case "Tab":
              event.preventDefault();
              highlightedAutocompleteIndex =
                (highlightedAutocompleteIndex + 1) % itemsCount;
              highlightAutocompleteItem($items);
              break;
            case "ArrowUp":
              event.preventDefault();
              highlightedAutocompleteIndex =
                (highlightedAutocompleteIndex - 1 + itemsCount) % itemsCount;
              highlightAutocompleteItem($items);
              break;
          }
        });

        function highlightAutocompleteItem($items) {
          $items.removeClass("autocomplete-highlight");
          if (highlightedAutocompleteIndex !== -1) {
            const $currentItem = $items.eq(highlightedAutocompleteIndex);
            $currentItem.addClass("autocomplete-highlight");
            // Scroll into view logic (simplified)
            const listElement = $("#autocomplete-list")[0];
            const itemElement = $currentItem[0];
            if (itemElement && listElement) {
              itemElement.scrollIntoView({
                block: "nearest",
                behavior: "auto",
              }); // Use 'auto' for less jarring scroll
            }
          }
        }

        // --- Select Autocomplete Suggestion (Click) ---
        $("#autocomplete-list").on("click", "li", function () {
          if (!roundActive) return;
          const selectedName = $(this).attr("data-value"); // Get normalized name
          $("#pokemon-guess").val(displayPokemonName(selectedName)); // Display formatted name
          $("#autocomplete-list").hide().empty();
          highlightedAutocompleteIndex = -1;
          checkGuess(selectedName); // Check guess with the normalized name
          // No focus needed here, checkGuess handles next step
        });

        // --- Hide Autocomplete on Click Outside ---
        $(document).on("click", function (event) {
          if (
            autocompleteEnabled &&
            !$(event.target).closest("#pokemon-guess, #autocomplete-list")
              .length
          ) {
            $("#autocomplete-list").hide();
            highlightedAutocompleteIndex = -1;
          }
        });

        // --- Check Guess Function ---
        function checkGuess(directGuess = null) {
          if (!roundActive || !gameIsActive) return;

          const userGuess = normalizeName(
            directGuess ? directGuess : $("#pokemon-guess").val()
          );
          const $feedback = $("#feedback");
          $("#autocomplete-list").hide();

          if (!userGuess) {
            $feedback
              .text("Please enter a Pokémon name.")
              .removeClass("correct incorrect")
              .addClass("info");
            return;
          }

          // Use normalizeName for comparison as well
          const normalizedCurrentPokemonName =
            normalizeName(currentPokemonName);

          if (userGuess === normalizedCurrentPokemonName) {
            correctCount++;
            updateScoreDisplay();
            const dexNumText = showDexNumberEnabled
              ? ` (#${currentPokemonId})`
              : "";
            $feedback
              .html(
                `Correct! It's ${displayPokemonName(
                  currentPokemonName
                )}<span class="dex-number">${dexNumText}</span>`
              )
              .removeClass("incorrect info")
              .addClass("correct");
            revealPokemon(false); // Reveal image, feedback already set
            $("#pokemon-guess").prop("disabled", true);
            $("#skip-pokemon").hide().prop("disabled", true); // Hide and disable skip
            $("#next-pokemon").show().focus();
            roundActive = false;
          } else {
            if (!firstIncorrectGuessMade) {
              incorrectCount++;
              firstIncorrectGuessMade = true;
              updateScoreDisplay();
            }
            $feedback
              .text("Incorrect! Try again.")
              .removeClass("correct info")
              .addClass("incorrect");
            $("#pokemon-guess").select(); // Select text for easy re-entry
          }
        }

        // --- Handle "Skip Pokémon" Button Click ---
        $("#skip-pokemon").on("click", function () {
          if (!roundActive || !gameIsActive) return;

          // Mark as incorrect only if it wasn't already marked incorrect
          if (!firstIncorrectGuessMade) {
            incorrectCount++;
            firstIncorrectGuessMade = true; // Prevents multiple increments if they guessed wrong then skipped
            updateScoreDisplay();
          }

          roundActive = false; // End the round
          $("#pokemon-guess").prop("disabled", true);
          $("#skip-pokemon").hide().prop("disabled", true); // Hide and disable skip itself
          $("#autocomplete-list").hide();

          // Reveal the answer
          revealPokemon(false); // Reveal image first
          const dexNumText = showDexNumberEnabled
            ? ` (#${currentPokemonId})`
            : "";
          $("#feedback")
            .html(
              `Skipped! It was ${displayPokemonName(
                currentPokemonName
              )}<span class="dex-number">${dexNumText}</span>`
            )
            .removeClass("correct correct")
            .addClass("incorrect"); // Show skipped feedback

          // Show the next button instead of auto-loading, feels less abrupt
          $("#next-pokemon").show().focus();

          // // Automatically load the next Pokémon after a short delay
          // setTimeout(() => {
          //     if (gameIsActive) { // Check if game didn't end in the meantime
          //         loadPokemon();
          //     }
          // }, 1500); // Delay to show the answer
        });

        // --- Handle "Next Pokémon" Button Click ---
        $("#next-pokemon").on("click", function () {
          if (gameIsActive) {
            loadPokemon();
          }
        });

        // --- Handle Start/Restart/Setup Button Clicks ---
        $("#start-game").on("click", startGame);
        $("#restart-game").on("click", startGame); // Restart uses the same startGame logic
        $("#return-to-setup").on("click", initGame);

        // --- Initial Setup ---
        populateGenerationCheckboxes(); // Add generation checkboxes to the DOM
        fetchAllPokemonNames(); // Start fetching all names immediately
        initGame(); // Set up the initial screen state
      });
    </script>
  </body>
</html>
